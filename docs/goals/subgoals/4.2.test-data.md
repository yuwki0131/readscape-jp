# 4.2 テストデータ

## 概要
一貫性のあるテストデータ管理により、信頼性の高いテスト実行環境を提供します。

## テスト用設定

### application-test.yml
```yaml
spring:
  application:
    name: readscape-api-test
  
  datasource:
    url: jdbc:tc:postgresql:15:///readscape_test
    driver-class-name: org.testcontainers.jdbc.ContainerDatabaseDriver
    hikari:
      maximum-pool-size: 5
      minimum-idle: 1
  
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        jdbc:
          time_zone: Asia/Tokyo
  
  flyway:
    enabled: false  # テストでは手動でスキーマ作成
  
  security:
    jwt:
      secret: test-jwt-secret-key-for-testing-only
      expiration: 3600000

server:
  port: 0  # ランダムポート

logging:
  level:
    jp.readscape: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.springframework.test: INFO
    org.springframework.web: DEBUG
```

### テスト専用データソース設定
```java
@TestConfiguration
public class TestDataSourceConfig {

    @Bean
    @Primary
    @Profile("test")
    public DataSource testDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:tc:postgresql:15:///readscape_test");
        config.setDriverClassName("org.testcontainers.jdbc.ContainerDatabaseDriver");
        config.setMaximumPoolSize(5);
        config.setMinimumIdle(1);
        config.setConnectionTimeout(30000);
        config.setIdleTimeout(600000);
        
        return new HikariDataSource(config);
    }
}
```

## モックデータ

### テストデータビルダー
```java
@Component
@Profile("test")
public class TestDataFactory {

    private final PasswordEncoder passwordEncoder;
    private static final AtomicLong SEQUENCE = new AtomicLong(1000);
    
    public TestDataFactory(PasswordEncoder passwordEncoder) {
        this.passwordEncoder = passwordEncoder;
    }
    
    // 書籍データ生成
    public Book createBook() {
        return createBook("テスト書籍", "テスト著者", 2500);
    }
    
    public Book createBook(String title, String author, Integer price) {
        return Book.builder()
                .id(SEQUENCE.getAndIncrement())
                .title(title)
                .author(author)
                .price(price)
                .isbn("978-4-" + String.format("%06d", SEQUENCE.get()) + "-0")
                .description("これは" + title + "の説明です。")
                .stockQuantity(50)
                .createdAt(LocalDateTime.now().minusDays(30))
                .updatedAt(LocalDateTime.now().minusDays(1))
                .build();
    }
    
    // カテゴリ付き書籍データ生成
    public Book createBookWithCategory(Category category) {
        Book book = createBook();
        book.setCategory(category);
        return book;
    }
    
    // 人気書籍データ生成
    public Book createPopularBook() {
        Book book = createBook("人気のSpring Boot入門", "人気著者", 3200);
        book.setStockQuantity(100);
        return book;
    }
    
    // カテゴリデータ生成
    public Category createCategory() {
        return createCategory("テストカテゴリ");
    }
    
    public Category createCategory(String name) {
        return Category.builder()
                .id(SEQUENCE.getAndIncrement())
                .name(name)
                .description(name + "の説明")
                .build();
    }
    
    // ユーザーデータ生成
    public User createUser() {
        return createUser("test" + SEQUENCE.getAndIncrement() + "@example.com", "password123");
    }
    
    public User createUser(String email, String password) {
        return User.builder()
                .id(SEQUENCE.getAndIncrement())
                .email(email)
                .username(extractUsernameFromEmail(email))
                .passwordHash(passwordEncoder.encode(password))
                .role(UserRole.CONSUMER)
                .createdAt(LocalDateTime.now().minusDays(10))
                .updatedAt(LocalDateTime.now().minusDays(1))
                .build();
    }
    
    // 管理者ユーザー生成
    public User createAdminUser() {
        return User.builder()
                .id(SEQUENCE.getAndIncrement())
                .email("admin" + SEQUENCE.get() + "@readscape.jp")
                .username("admin" + SEQUENCE.get())
                .passwordHash(passwordEncoder.encode("admin123"))
                .role(UserRole.ADMIN)
                .createdAt(LocalDateTime.now().minusDays(100))
                .updatedAt(LocalDateTime.now().minusDays(1))
                .build();
    }
    
    // カートデータ生成
    public Cart createCart(User user) {
        return Cart.builder()
                .id(SEQUENCE.getAndIncrement())
                .user(user)
                .createdAt(LocalDateTime.now().minusDays(1))
                .build();
    }
    
    // カートアイテム生成
    public CartItem createCartItem(Cart cart, Book book, Integer quantity) {
        return CartItem.builder()
                .id(SEQUENCE.getAndIncrement())
                .cart(cart)
                .book(book)
                .quantity(quantity)
                .build();
    }
    
    // 注文データ生成
    public Order createOrder(User user) {
        return Order.builder()
                .id(SEQUENCE.getAndIncrement())
                .user(user)
                .totalPrice(5000)
                .status(OrderStatus.PENDING)
                .paymentMethod("credit_card")
                .shippingAddress("東京都渋谷区テスト1-1-1")
                .createdAt(LocalDateTime.now().minusDays(7))
                .updatedAt(LocalDateTime.now().minusDays(7))
                .build();
    }
    
    // 注文アイテム生成
    public OrderItem createOrderItem(Order order, Book book, Integer quantity) {
        return OrderItem.builder()
                .id(SEQUENCE.getAndIncrement())
                .order(order)
                .book(book)
                .price(book.getPrice())
                .quantity(quantity)
                .build();
    }
    
    // レビューデータ生成
    public Review createReview(Book book, User user) {
        return createReview(book, user, 4, "とても良い本でした。");
    }
    
    public Review createReview(Book book, User user, Integer rating, String comment) {
        return Review.builder()
                .id(SEQUENCE.getAndIncrement())
                .book(book)
                .user(user)
                .rating(rating)
                .comment(comment)
                .createdAt(LocalDateTime.now().minusDays(3))
                .build();
    }
    
    private String extractUsernameFromEmail(String email) {
        return email.split("@")[0];
    }
}
```

### データセットビルダー
```java
@Component
@Profile("test")
public class TestDataSetBuilder {

    private final TestDataFactory dataFactory;
    
    public TestDataSetBuilder(TestDataFactory dataFactory) {
        this.dataFactory = dataFactory;
    }
    
    // 完全な書籍ストアデータセット
    public BookStoreDataSet createBookStoreDataSet() {
        // カテゴリ作成
        Category techCategory = dataFactory.createCategory("技術書");
        Category businessCategory = dataFactory.createCategory("ビジネス書");
        Category novelCategory = dataFactory.createCategory("小説");
        
        // 書籍作成
        Book springBook = dataFactory.createBookWithCategory(techCategory);
        springBook.setTitle("Spring Boot実践入門");
        springBook.setAuthor("技術太郎");
        springBook.setPrice(3200);
        
        Book javaBook = dataFactory.createBookWithCategory(techCategory);
        javaBook.setTitle("Java設計パターン");
        javaBook.setAuthor("設計花子");
        javaBook.setPrice(2800);
        
        Book businessBook = dataFactory.createBookWithCategory(businessCategory);
        businessBook.setTitle("マーケティング戦略");
        businessBook.setAuthor("ビジネス次郎");
        businessBook.setPrice(2200);
        
        // ユーザー作成
        User regularUser = dataFactory.createUser("user@example.com", "password123");
        User adminUser = dataFactory.createAdminUser();
        
        // カート作成
        Cart userCart = dataFactory.createCart(regularUser);
        CartItem cartItem1 = dataFactory.createCartItem(userCart, springBook, 1);
        CartItem cartItem2 = dataFactory.createCartItem(userCart, javaBook, 2);
        
        // 注文作成
        Order completedOrder = dataFactory.createOrder(regularUser);
        completedOrder.setStatus(OrderStatus.COMPLETED);
        OrderItem orderItem1 = dataFactory.createOrderItem(completedOrder, springBook, 1);
        
        // レビュー作成
        Review review1 = dataFactory.createReview(springBook, regularUser, 5, "素晴らしい内容でした！");
        Review review2 = dataFactory.createReview(javaBook, regularUser, 4, "実践的で役に立ちました。");
        
        return BookStoreDataSet.builder()
                .categories(List.of(techCategory, businessCategory, novelCategory))
                .books(List.of(springBook, javaBook, businessBook))
                .users(List.of(regularUser, adminUser))
                .carts(List.of(userCart))
                .cartItems(List.of(cartItem1, cartItem2))
                .orders(List.of(completedOrder))
                .orderItems(List.of(orderItem1))
                .reviews(List.of(review1, review2))
                .build();
    }
    
    // 大量データセット（パフォーマンステスト用）
    public LargeDataSet createLargeDataSet(int bookCount, int userCount) {
        List<Category> categories = IntStream.range(0, 10)
                .mapToObj(i -> dataFactory.createCategory("カテゴリ" + i))
                .collect(Collectors.toList());
        
        List<Book> books = IntStream.range(0, bookCount)
                .mapToObj(i -> {
                    Category category = categories.get(i % categories.size());
                    Book book = dataFactory.createBookWithCategory(category);
                    book.setTitle("書籍タイトル" + i);
                    book.setAuthor("著者" + (i % 100));
                    book.setPrice(1000 + (i % 3000));
                    return book;
                })
                .collect(Collectors.toList());
        
        List<User> users = IntStream.range(0, userCount)
                .mapToObj(i -> dataFactory.createUser("user" + i + "@example.com", "password"))
                .collect(Collectors.toList());
        
        return LargeDataSet.builder()
                .categories(categories)
                .books(books)
                .users(users)
                .build();
    }
}

// データセットクラス
@Data
@Builder
public class BookStoreDataSet {
    private List<Category> categories;
    private List<Book> books;
    private List<User> users;
    private List<Cart> carts;
    private List<CartItem> cartItems;
    private List<Order> orders;
    private List<OrderItem> orderItems;
    private List<Review> reviews;
}

@Data
@Builder
public class LargeDataSet {
    private List<Category> categories;
    private List<Book> books;
    private List<User> users;
}
```

## テストシナリオ

### 統合テスト用シナリオデータ
```java
@Component
@Profile("test")
public class TestScenarioBuilder {

    private final TestDataFactory dataFactory;
    private final TestDataSetBuilder dataSetBuilder;
    
    // ユーザー登録〜購入完了シナリオ
    @Transactional
    public PurchaseScenarioData createPurchaseScenario() {
        // 1. 商品準備
        Category category = dataFactory.createCategory("人気書籍");
        Book availableBook = dataFactory.createBookWithCategory(category);
        availableBook.setStockQuantity(10);
        
        // 2. 新規ユーザー
        User newUser = User.builder()
                .email("newuser@example.com")
                .username("newuser")
                .passwordHash("$2a$10$encoded-password")
                .role(UserRole.CONSUMER)
                .build();
        
        // 3. カート準備
        Cart emptyCart = dataFactory.createCart(newUser);
        
        return PurchaseScenarioData.builder()
                .targetBook(availableBook)
                .customer(newUser)
                .cart(emptyCart)
                .build();
    }
    
    // 在庫不足エラーシナリオ
    public StockShortageScenarioData createStockShortageScenario() {
        Book lowStockBook = dataFactory.createBook();
        lowStockBook.setStockQuantity(1); // 在庫1個
        lowStockBook.setTitle("在庫僅少書籍");
        
        User customer1 = dataFactory.createUser("customer1@example.com", "password");
        User customer2 = dataFactory.createUser("customer2@example.com", "password");
        
        return StockShortageScenarioData.builder()
                .book(lowStockBook)
                .customer1(customer1)
                .customer2(customer2)
                .requestedQuantity(2)
                .build();
    }
    
    // セキュリティテストシナリオ
    public SecurityTestScenarioData createSecurityTestScenario() {
        User regularUser = dataFactory.createUser("regular@example.com", "userpass");
        User adminUser = dataFactory.createAdminUser();
        
        Book sensitiveBook = dataFactory.createBook();
        sensitiveBook.setTitle("管理者限定書籍");
        
        return SecurityTestScenarioData.builder()
                .regularUser(regularUser)
                .adminUser(adminUser)
                .sensitiveBook(sensitiveBook)
                .build();
    }
}

// シナリオデータクラス
@Data
@Builder
public class PurchaseScenarioData {
    private Book targetBook;
    private User customer;
    private Cart cart;
}

@Data
@Builder  
public class StockShortageScenarioData {
    private Book book;
    private User customer1;
    private User customer2;
    private Integer requestedQuantity;
}

@Data
@Builder
public class SecurityTestScenarioData {
    private User regularUser;
    private User adminUser;
    private Book sensitiveBook;
}
```

### テストデータ初期化ユーティリティ
```java
@TestComponent
public class TestDataInitializer {

    private final EntityManager entityManager;
    private final TestDataSetBuilder dataSetBuilder;
    
    @Transactional
    public void initializeMinimalDataSet() {
        BookStoreDataSet dataSet = dataSetBuilder.createBookStoreDataSet();
        
        // カテゴリ保存
        dataSet.getCategories().forEach(entityManager::persist);
        
        // 書籍保存
        dataSet.getBooks().forEach(entityManager::persist);
        
        // ユーザー保存
        dataSet.getUsers().forEach(entityManager::persist);
        
        entityManager.flush();
    }
    
    @Transactional
    public void initializeFullDataSet() {
        BookStoreDataSet dataSet = dataSetBuilder.createBookStoreDataSet();
        
        // 全データ保存
        dataSet.getCategories().forEach(entityManager::persist);
        dataSet.getBooks().forEach(entityManager::persist);
        dataSet.getUsers().forEach(entityManager::persist);
        dataSet.getCarts().forEach(entityManager::persist);
        dataSet.getCartItems().forEach(entityManager::persist);
        dataSet.getOrders().forEach(entityManager::persist);
        dataSet.getOrderItems().forEach(entityManager::persist);
        dataSet.getReviews().forEach(entityManager::persist);
        
        entityManager.flush();
    }
    
    @Transactional
    public void cleanupAllData() {
        // 関連データから順に削除
        entityManager.createNativeQuery("DELETE FROM readscape.reviews").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.order_items").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.orders").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.cart_items").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.carts").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.books").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.categories").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM readscape.users").executeUpdate();
        
        entityManager.flush();
    }
}
```

### JSON テストデータファイル
```json
// test-books.json
{
  "books": [
    {
      "title": "Spring Boot マスターブック",
      "author": "Spring太郎",
      "isbn": "978-4-123456-78-9",
      "price": 3200,
      "category": "技術書",
      "stockQuantity": 25,
      "description": "Spring Boot の基本から応用まで幅広く解説"
    },
    {
      "title": "Java 設計パターン入門",
      "author": "パターン花子", 
      "isbn": "978-4-234567-89-0",
      "price": 2800,
      "category": "技術書",
      "stockQuantity": 15,
      "description": "GoF パターンを Java で実践的に学ぶ"
    }
  ],
  "users": [
    {
      "email": "testuser1@example.com",
      "username": "testuser1",
      "password": "password123",
      "role": "CONSUMER"
    },
    {
      "email": "admin@readscape.jp",
      "username": "admin",
      "password": "admin123",
      "role": "ADMIN"
    }
  ]
}
```

## 技術仕様
- データ生成: TestDataFactory + Builder パターン
- コンテナ: TestContainers PostgreSQL
- トランザクション: @Transactional + @Rollback
- データ初期化: @Sql, @DirtiesContext
- JSON データ: Jackson + @JsonTest