# 2.2 設定ファイル

## 概要
Spring Boot アプリケーションの各種設定ファイルと環境別の設定管理を提供します。

## アプリケーション設定

### application.yml（メイン設定）
```yaml
spring:
  application:
    name: readscape-api
  
  profiles:
    active: dev
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          time_zone: Asia/Tokyo
  
  flyway:
    enabled: true
    schemas: readscape
    locations: classpath:db/migration
    baseline-on-migrate: true
  
  security:
    jwt:
      secret: ${JWT_SECRET:default-jwt-secret-key-change-in-production}
      expiration: 3600000  # 1時間（ミリ秒）
      refresh-expiration: 2592000000  # 30日（ミリ秒）

server:
  port: 8080
  servlet:
    context-path: /api
  error:
    include-stacktrace: never
    include-message: always

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when_authorized

logging:
  level:
    root: INFO
    jp.readscape: INFO
    org.springframework.security: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### application-dev.yml（開発環境）
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/readscape_dev
    username: readscape_user
    password: readscape_pass
    driver-class-name: org.postgresql.Driver
  
  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
  
  security:
    jwt:
      secret: dev-jwt-secret-key-for-development-only

logging:
  level:
    jp.readscape: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

server:
  error:
    include-stacktrace: always
```

### application-docker.yml（Docker環境）
```yaml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:postgres}:${DB_PORT:5432}/${DB_NAME:readscape}
    username: ${DB_USER:readscape_user}
    password: ${DB_PASSWORD:readscape_pass}
    driver-class-name: org.postgresql.Driver
  
  security:
    jwt:
      secret: ${JWT_SECRET:docker-jwt-secret-change-in-production}

logging:
  level:
    jp.readscape: INFO
  file:
    name: /app/logs/readscape-api.log
```

### application-prod.yml（本番環境）
```yaml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      connection-timeout: 20000
      validation-timeout: 5000
  
  jpa:
    show-sql: false
  
  security:
    jwt:
      secret: ${JWT_SECRET}

server:
  error:
    include-stacktrace: never

logging:
  level:
    root: WARN
    jp.readscape: INFO
  file:
    name: /var/log/readscape/readscape-api.log
    max-size: 100MB
    max-history: 30
```

## データベース接続設定

### HikariCP接続プール設定
```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: ReadscapeHikariPool
      maximum-pool-size: 20          # 最大接続数
      minimum-idle: 5                # 最小アイドル接続数
      idle-timeout: 300000           # アイドルタイムアウト（5分）
      connection-timeout: 20000      # 接続タイムアウト（20秒）
      validation-timeout: 5000       # バリデーションタイムアウト（5秒）
      max-lifetime: 1800000          # 最大ライフタイム（30分）
      leak-detection-threshold: 60000 # リーク検出閾値（1分）
      connection-test-query: SELECT 1
      auto-commit: true
```

### 接続プール監視設定
```yaml
management:
  metrics:
    export:
      prometheus:
        enabled: true
  endpoint:
    metrics:
      enabled: true
    prometheus:
      enabled: true
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
```

## プロファイル設定

### プロファイル切り替え方法

#### 1. 環境変数による設定
```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar readscape-api.jar
```

#### 2. JVMシステムプロパティ
```bash
java -Dspring.profiles.active=prod -jar readscape-api.jar
```

#### 3. application.yml内での設定
```yaml
spring:
  profiles:
    active: dev
```

### 複数プロファイル同時適用
```yaml
spring:
  profiles:
    active: docker,monitoring
```

## セキュリティ設定

### JWT設定詳細
```yaml
app:
  security:
    jwt:
      secret: ${JWT_SECRET}
      token-validity-in-seconds: 3600      # アクセストークン有効期限
      refresh-token-validity-in-seconds: 2592000  # リフレッシュトークン有効期限
      header: Authorization
      prefix: "Bearer "
    
    cors:
      allowed-origins: 
        - "http://localhost:3000"
        - "https://readscape.jp"
      allowed-methods: GET,POST,PUT,DELETE,OPTIONS
      allowed-headers: "*"
      allow-credentials: true
      max-age: 3600
```

### HTTPS設定（本番環境）
```yaml
server:
  port: 8443
  ssl:
    enabled: true
    key-store: ${SSL_KEY_STORE_PATH:classpath:keystore.p12}
    key-store-password: ${SSL_KEY_STORE_PASSWORD}
    key-store-type: PKCS12
    key-alias: readscape
  http2:
    enabled: true
```

## ログ設定

### Logback設定（logback-spring.xml）
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProfile name="dev,docker">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
        </root>
    </springProfile>

    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/readscape/readscape-api.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>/var/log/readscape/readscape-api.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>3GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="FILE" />
        </root>
    </springProfile>
</configuration>
```

## バリデーション設定

### Bean Validation設定
```yaml
spring:
  validation:
    enabled: true
  messages:
    basename: messages/validation
    encoding: UTF-8
```

### カスタムメッセージファイル
```properties
# messages/validation_ja.properties
javax.validation.constraints.NotNull.message=必須項目です
javax.validation.constraints.NotEmpty.message=空の値は許可されていません
javax.validation.constraints.Size.message=文字数は{min}文字以上{max}文字以下で入力してください
javax.validation.constraints.Email.message=正しいメールアドレスを入力してください
javax.validation.constraints.Min.message={value}以上の値を入力してください
javax.validation.constraints.Max.message={value}以下の値を入力してください
```

## 環境変数管理

### 本番環境での環境変数
```bash
# データベース接続
DB_HOST=production-db-host
DB_PORT=5432
DB_NAME=readscape_prod
DB_USER=readscape_prod_user
DB_PASSWORD=secure-production-password

# JWT設定
JWT_SECRET=very-secure-jwt-secret-key-change-regularly

# SSL証明書
SSL_KEY_STORE_PATH=/etc/ssl/certs/readscape.p12
SSL_KEY_STORE_PASSWORD=ssl-keystore-password

# 監視・ログ
MONITORING_ENABLED=true
LOG_LEVEL=INFO
```

## 技術仕様
- 設定管理: Spring Boot Configuration Properties
- プロファイル: Spring Profiles
- 外部設定: Environment Variables + YAML
- 接続プール: HikariCP
- ログ: Logback + SLF4J