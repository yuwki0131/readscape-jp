# 5.2 運用スクリプト

## 概要
システムの初期化、メンテナンス、運用に必要な自動化スクリプト群を提供します。

## 初期化スクリプト

### プロジェクト環境構築用スクリプト
```bash
#!/bin/bash
# scripts/init-project.sh

set -e

PROJECT_NAME="readscape-jp"
PROJECT_DIR="$(pwd)"

echo "🚀 Initializing $PROJECT_NAME development environment..."

# 必要なソフトウェアのバージョンチェック
check_prerequisites() {
    echo "📋 Checking prerequisites..."
    
    # Java 21チェック
    if command -v java >/dev/null 2>&1; then
        JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1)
        if [ "$JAVA_VERSION" -ge 21 ]; then
            echo "✅ Java $JAVA_VERSION detected"
        else
            echo "❌ Java 21 or higher required. Current: $JAVA_VERSION"
            exit 1
        fi
    else
        echo "❌ Java not found. Please install Java 21+"
        exit 1
    fi
    
    # Docker チェック
    if command -v docker >/dev/null 2>&1; then
        DOCKER_VERSION=$(docker --version | awk '{print $3}' | sed 's/,//')
        echo "✅ Docker $DOCKER_VERSION detected"
    else
        echo "❌ Docker not found. Please install Docker 24.0+"
        exit 1
    fi
    
    # Docker Compose チェック  
    if command -v docker-compose >/dev/null 2>&1; then
        COMPOSE_VERSION=$(docker-compose --version | awk '{print $3}' | sed 's/,//')
        echo "✅ Docker Compose $COMPOSE_VERSION detected"
    else
        echo "❌ Docker Compose not found. Please install Docker Compose 2.20+"
        exit 1
    fi
}

# 環境変数ファイル作成
setup_environment() {
    echo "🔧 Setting up environment configuration..."
    
    if [ ! -f ".env" ]; then
        cp .env.example .env
        echo "✅ Created .env file from template"
        echo "⚠️  Please edit .env file with your settings"
    else
        echo "ℹ️  .env file already exists"
    fi
}

# Docker 環境初期化
setup_docker() {
    echo "🐳 Setting up Docker environment..."
    
    # 既存のコンテナ停止・削除
    if docker-compose ps | grep -q "Up"; then
        echo "Stopping existing containers..."
        docker-compose down
    fi
    
    # Docker イメージビルド
    echo "Building Docker images..."
    docker-compose build --no-cache
    
    # コンテナ起動
    echo "Starting containers..."
    docker-compose up -d
    
    # データベース起動待機
    echo "Waiting for database to be ready..."
    timeout 60s bash -c 'until docker-compose exec postgres pg_isready -U readscape_user; do sleep 1; done'
    
    if [ $? -eq 0 ]; then
        echo "✅ Database is ready"
    else
        echo "❌ Database startup timeout"
        exit 1
    fi
}

# データベース初期化
setup_database() {
    echo "🗄️  Setting up database..."
    
    cd backend
    
    # データベースマイグレーション実行
    echo "Running database migrations..."
    ./gradlew flywayMigrate
    
    if [ $? -eq 0 ]; then
        echo "✅ Database migrations completed"
    else
        echo "❌ Database migration failed"
        exit 1
    fi
    
    cd ..
}

# アプリケーション動作確認
verify_setup() {
    echo "🔍 Verifying setup..."
    
    # アプリケーション起動
    cd backend
    echo "Starting application..."
    ./gradlew bootRun > ../logs/app-startup.log 2>&1 &
    APP_PID=$!
    cd ..
    
    # 起動待機
    echo "Waiting for application to start..."
    for i in {1..30}; do
        if curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
            echo "✅ Application is running"
            kill $APP_PID 2>/dev/null || true
            return 0
        fi
        sleep 2
    done
    
    echo "❌ Application startup timeout"
    kill $APP_PID 2>/dev/null || true
    exit 1
}

# メイン実行
main() {
    echo "Starting project initialization..."
    
    check_prerequisites
    setup_environment
    setup_docker
    setup_database
    verify_setup
    
    echo ""
    echo "🎉 Project initialization completed successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. Edit .env file with your configuration"
    echo "  2. Run: cd backend && ./gradlew bootRun"
    echo "  3. Open: http://localhost:8080/api/swagger-ui.html"
    echo ""
}

# ログディレクトリ作成
mkdir -p logs

# 実行
main "$@"
```

### バックエンド初期化スクリプト
```bash
#!/bin/bash
# workscripts/init-backend.sh

set -e

BACKEND_DIR="backend"
GRADLE_WRAPPER="./gradlew"

echo "🔧 Initializing backend application..."

# バックエンドディレクトリ移動
cd "$BACKEND_DIR"

# Gradle Wrapper 権限設定
chmod +x gradlew

# 依存関係ダウンロード
echo "📦 Downloading dependencies..."
$GRADLE_WRAPPER dependencies --refresh-dependencies

# コンパイルチェック
echo "🔨 Compiling source code..."
$GRADLE_WRAPPER compileJava compileTestJava

# テスト実行
echo "🧪 Running tests..."
$GRADLE_WRAPPER test

# 静的解析
echo "🔍 Running static analysis..."
$GRADLE_WRAPPER checkstyleMain spotbugsMain

# アプリケーション起動テスト
echo "🚀 Testing application startup..."
timeout 30s $GRADLE_WRAPPER bootRun --args='--spring.profiles.active=test' || {
    if [ $? -eq 124 ]; then
        echo "✅ Application startup test completed (timeout expected)"
    else
        echo "❌ Application startup failed"
        exit 1
    fi
}

echo "✅ Backend initialization completed!"
```

## マイグレーションスクリプト

### データベースマイグレーションスクリプト
```bash
#!/bin/bash
# infrastructure/db/migrate.sh

set -e

# 設定読み込み
source "$(dirname "$0")/../.env" 2>/dev/null || true

DB_HOST=${DB_HOST:-localhost}
DB_PORT=${DB_PORT:-5432}
DB_NAME=${DB_NAME:-readscape}
DB_USER=${DB_USER:-readscape_user}
DB_PASSWORD=${DB_PASSWORD:-readscape_pass}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
MIGRATION_DIR="$SCRIPT_DIR/migration/sql"

echo "🗄️  Database Migration Script"
echo "================================"
echo "Host: $DB_HOST:$DB_PORT"
echo "Database: $DB_NAME"
echo "User: $DB_USER"
echo ""

# PostgreSQLクライアント確認
if ! command -v psql >/dev/null 2>&1; then
    echo "❌ psql command not found. Please install PostgreSQL client."
    exit 1
fi

# データベース接続テスト
test_connection() {
    echo "🔍 Testing database connection..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d postgres -c "SELECT version();" >/dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "✅ Database connection successful"
    else
        echo "❌ Database connection failed"
        exit 1
    fi
}

# データベース作成（存在しない場合）
create_database() {
    echo "🏗️  Checking database existence..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$DB_NAME';" | grep -q 1
    
    if [ $? -ne 0 ]; then
        echo "Creating database: $DB_NAME"
        PGPASSWORD=$DB_PASSWORD createdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME
        echo "✅ Database created"
    else
        echo "ℹ️  Database already exists"
    fi
}

# マイグレーション履歴テーブル作成
create_migration_history() {
    echo "📋 Setting up migration history..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
CREATE TABLE IF NOT EXISTS migration_history (
    id SERIAL PRIMARY KEY,
    version VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_time INTERVAL,
    checksum VARCHAR(64)
);
EOF
    
    echo "✅ Migration history table ready"
}

# マイグレーション実行
execute_migrations() {
    echo "🚀 Executing migrations..."
    
    for migration_file in $(ls $MIGRATION_DIR/V*.sql | sort -V); do
        filename=$(basename "$migration_file")
        version=$(echo "$filename" | sed 's/V\([0-9]*\)__.*/\1/')
        description=$(echo "$filename" | sed 's/V[0-9]*__\(.*\)\.sql/\1/')
        
        # 既に実行済みかチェック
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -tc "SELECT 1 FROM migration_history WHERE version = '$version';" | grep -q 1
        
        if [ $? -eq 0 ]; then
            echo "⏭️  Skipping $filename (already executed)"
            continue
        fi
        
        echo "📝 Executing $filename..."
        start_time=$(date +%s)
        
        # チェックサム計算
        checksum=$(sha256sum "$migration_file" | awk '{print $1}')
        
        # マイグレーション実行
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "$migration_file"
        
        if [ $? -eq 0 ]; then
            end_time=$(date +%s)
            execution_time=$((end_time - start_time))
            
            # 実行履歴記録
            PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
INSERT INTO migration_history (version, description, execution_time, checksum) 
VALUES ('$version', '$description', '$execution_time seconds', '$checksum');
EOF
            echo "✅ $filename executed successfully (${execution_time}s)"
        else
            echo "❌ Migration failed: $filename"
            exit 1
        fi
    done
}

# マイグレーション状態表示
show_migration_status() {
    echo ""
    echo "📊 Migration Status:"
    echo "===================="
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
SELECT 
    version,
    description,
    executed_at,
    execution_time
FROM migration_history 
ORDER BY version::integer;
EOF
}

# メイン実行
main() {
    case "${1:-migrate}" in
        "migrate")
            test_connection
            create_database
            create_migration_history
            execute_migrations
            show_migration_status
            echo "🎉 Database migration completed!"
            ;;
        "status")
            test_connection
            show_migration_status
            ;;
        "reset")
            echo "⚠️  This will DROP the entire database!"
            read -p "Are you sure? (yes/no): " confirm
            if [ "$confirm" = "yes" ]; then
                PGPASSWORD=$DB_PASSWORD dropdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME --if-exists
                echo "✅ Database dropped"
                main "migrate"
            else
                echo "Operation cancelled"
            fi
            ;;
        *)
            echo "Usage: $0 [migrate|status|reset]"
            echo "  migrate: Run pending migrations (default)"
            echo "  status:  Show migration status"
            echo "  reset:   Drop and recreate database"
            ;;
    esac
}

# 実行
main "$@"
```

## 運用スクリプト

### システム起動・停止スクリプト
```bash
#!/bin/bash
# scripts/system-control.sh

set -e

SERVICE_NAME="readscape-api"
APP_DIR="/opt/readscape"
LOG_FILE="/var/log/readscape/system-control.log"
PID_FILE="$APP_DIR/readscape-api.pid"

# ログ関数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# プロセス存在確認
is_running() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        ps -p $PID > /dev/null 2>&1
        return $?
    fi
    return 1
}

# アプリケーション起動
start_app() {
    log "Starting $SERVICE_NAME..."
    
    if is_running; then
        log "⚠️  $SERVICE_NAME is already running"
        return 0
    fi
    
    # 前回の PID ファイル削除
    [ -f "$PID_FILE" ] && rm -f "$PID_FILE"
    
    # systemd サービスとして起動
    if command -v systemctl >/dev/null 2>&1; then
        sudo systemctl start $SERVICE_NAME
        
        # 起動確認
        sleep 5
        if systemctl is-active --quiet $SERVICE_NAME; then
            log "✅ $SERVICE_NAME started successfully"
        else
            log "❌ Failed to start $SERVICE_NAME"
            return 1
        fi
    else
        # 直接起動（systemd 未使用環境）
        cd "$APP_DIR"
        nohup java -jar readscape-api.jar > /dev/null 2>&1 &
        echo $! > "$PID_FILE"
        
        # 起動確認
        sleep 10
        if is_running && curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
            log "✅ $SERVICE_NAME started successfully"
        else
            log "❌ Failed to start $SERVICE_NAME"
            return 1
        fi
    fi
}

# アプリケーション停止
stop_app() {
    log "Stopping $SERVICE_NAME..."
    
    if ! is_running; then
        log "ℹ️  $SERVICE_NAME is not running"
        return 0
    fi
    
    if command -v systemctl >/dev/null 2>&1; then
        sudo systemctl stop $SERVICE_NAME
        log "✅ $SERVICE_NAME stopped"
    else
        # 直接停止
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            kill $PID
            
            # 正常終了待機
            for i in {1..30}; do
                if ! ps -p $PID > /dev/null 2>&1; then
                    rm -f "$PID_FILE"
                    log "✅ $SERVICE_NAME stopped gracefully"
                    return 0
                fi
                sleep 1
            done
            
            # 強制終了
            kill -9 $PID 2>/dev/null || true
            rm -f "$PID_FILE"
            log "⚠️  $SERVICE_NAME force stopped"
        fi
    fi
}

# アプリケーション再起動
restart_app() {
    log "Restarting $SERVICE_NAME..."
    stop_app
    sleep 3
    start_app
}

# ステータス確認
status_app() {
    echo "🔍 $SERVICE_NAME Status"
    echo "======================="
    
    if command -v systemctl >/dev/null 2>&1; then
        systemctl status $SERVICE_NAME --no-pager
    else
        if is_running; then
            echo "Status: Running"
            echo "PID: $(cat $PID_FILE)"
        else
            echo "Status: Stopped"
        fi
    fi
    
    # ヘルスチェック
    echo ""
    echo "🏥 Health Check"
    echo "==============="
    
    if curl -f http://localhost:8080/api/actuator/health 2>/dev/null; then
        echo ""
        echo "✅ Application is healthy"
    else
        echo "❌ Application health check failed"
    fi
}

# ログ表示
show_logs() {
    local lines=${1:-100}
    
    if command -v journalctl >/dev/null 2>&1; then
        echo "📋 Application Logs (last $lines lines)"
        echo "======================================"
        journalctl -u $SERVICE_NAME -n $lines --no-pager
    else
        echo "📋 System Control Logs (last $lines lines)"  
        echo "=========================================="
        tail -n $lines "$LOG_FILE"
    fi
}

# ヘルプ表示
show_help() {
    echo "Usage: $0 {start|stop|restart|status|logs|help}"
    echo ""
    echo "Commands:"
    echo "  start     Start the application"
    echo "  stop      Stop the application" 
    echo "  restart   Restart the application"
    echo "  status    Show application status"
    echo "  logs      Show recent logs"
    echo "  help      Show this help message"
}

# メイン処理
case "${1:-help}" in
    "start")
        start_app
        ;;
    "stop")
        stop_app
        ;;
    "restart") 
        restart_app
        ;;
    "status")
        status_app
        ;;
    "logs")
        show_logs "${2:-100}"
        ;;
    "help"|*)
        show_help
        ;;
esac
```

### バックアップ・メンテナンススクリプト
```bash
#!/bin/bash
# scripts/maintenance.sh

set -e

BACKUP_DIR="/backup/readscape"
LOG_FILE="/var/log/readscape/maintenance.log"
RETENTION_DAYS=30

# 設定読み込み
source /opt/readscape/.env 2>/dev/null || {
    echo "Environment file not found"
    exit 1
}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# データベースバックアップ
backup_database() {
    log "🗄️  Starting database backup..."
    
    mkdir -p "$BACKUP_DIR"
    
    BACKUP_FILE="$BACKUP_DIR/readscape_$(date +%Y%m%d_%H%M%S).sql"
    
    PGPASSWORD=$DB_PASSWORD pg_dump \
        -h $DB_HOST \
        -p $DB_PORT \
        -U $DB_USER \
        -d $DB_NAME \
        --verbose \
        --no-password \
        > "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        # 圧縮
        gzip "$BACKUP_FILE"
        log "✅ Database backup completed: ${BACKUP_FILE}.gz"
        
        # 古いバックアップの削除
        find "$BACKUP_DIR" -name "readscape_*.sql.gz" -mtime +$RETENTION_DAYS -delete
        log "🧹 Old backups cleaned up (older than $RETENTION_DAYS days)"
    else
        log "❌ Database backup failed"
        return 1
    fi
}

# ログローテーション
rotate_logs() {
    log "📄 Starting log rotation..."
    
    LOG_DIR="/var/log/readscape"
    
    # アプリケーションログのローテーション
    if [ -f "$LOG_DIR/readscape-api.log" ]; then
        mv "$LOG_DIR/readscape-api.log" "$LOG_DIR/readscape-api.log.$(date +%Y%m%d_%H%M%S)"
        touch "$LOG_DIR/readscape-api.log"
        chown readscape:readscape "$LOG_DIR/readscape-api.log"
        
        # 古いログファイルの圧縮・削除
        find "$LOG_DIR" -name "readscape-api.log.*" -mtime +1 -not -name "*.gz" -exec gzip {} \;
        find "$LOG_DIR" -name "readscape-api.log.*.gz" -mtime +$RETENTION_DAYS -delete
        
        log "✅ Application logs rotated"
    fi
}

# システム情報収集
collect_system_info() {
    log "📊 Collecting system information..."
    
    INFO_FILE="/tmp/readscape_system_info_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "=== System Information ==="
        echo "Date: $(date)"
        echo "Hostname: $(hostname)"
        echo "Uptime: $(uptime)"
        echo ""
        
        echo "=== Disk Usage ==="
        df -h
        echo ""
        
        echo "=== Memory Usage ==="
        free -h
        echo ""
        
        echo "=== Application Status ==="
        systemctl status readscape-api --no-pager || echo "Service status unavailable"
        echo ""
        
        echo "=== Database Status ==="
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "\l" || echo "Database connection failed"
        echo ""
        
        echo "=== Recent Errors ==="
        journalctl -u readscape-api --since "1 hour ago" --grep "ERROR" --no-pager || echo "No recent errors found"
        
    } > "$INFO_FILE"
    
    log "✅ System information collected: $INFO_FILE"
}

# ヘルス チェック
health_check() {
    log "🏥 Starting comprehensive health check..."
    
    local issues=0
    
    # アプリケーション ヘルスチェック
    if ! curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
        log "❌ Application health check failed"
        issues=$((issues + 1))
    else
        log "✅ Application is healthy"
    fi
    
    # データベース接続チェック
    if ! PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "SELECT 1;" >/dev/null 2>&1; then
        log "❌ Database connection failed"
        issues=$((issues + 1))
    else
        log "✅ Database connection is healthy"
    fi
    
    # ディスク使用量チェック
    DISK_USAGE=$(df /opt/readscape | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 80 ]; then
        log "⚠️  High disk usage: $DISK_USAGE%"
        issues=$((issues + 1))
    else
        log "✅ Disk usage is normal: $DISK_USAGE%"
    fi
    
    # メモリ使用量チェック
    MEMORY_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2 }')
    if [ $MEMORY_USAGE -gt 90 ]; then
        log "⚠️  High memory usage: $MEMORY_USAGE%"
        issues=$((issues + 1))
    else
        log "✅ Memory usage is normal: $MEMORY_USAGE%"
    fi
    
    if [ $issues -eq 0 ]; then
        log "🎉 All health checks passed"
        return 0
    else
        log "⚠️  Found $issues issues"
        return 1
    fi
}

# フルメンテナンス
full_maintenance() {
    log "🔧 Starting full maintenance..."
    
    backup_database
    rotate_logs
    collect_system_info
    health_check
    
    log "✅ Full maintenance completed"
}

# ヘルプ
show_help() {
    echo "Usage: $0 {backup|rotate|info|health|full|help}"
    echo ""
    echo "Commands:"
    echo "  backup    Create database backup"
    echo "  rotate    Rotate log files"
    echo "  info      Collect system information"
    echo "  health    Run health checks"
    echo "  full      Run full maintenance"
    echo "  help      Show this help"
}

# メイン処理
case "${1:-help}" in
    "backup")
        backup_database
        ;;
    "rotate")
        rotate_logs
        ;;
    "info")
        collect_system_info
        ;;
    "health")
        health_check
        ;;
    "full")
        full_maintenance
        ;;
    "help"|*)
        show_help
        ;;
esac
```

## 技術仕様
- シェル: Bash 4.0+ with set -e (エラー時終了)
- 依存関係: PostgreSQL client, curl, systemd
- ログ: 構造化ログ with timestamp
- エラーハンドリング: 適切な終了コードとログ出力
- セキュリティ: 環境変数での機密情報管理