# 3.3 運用文書

## 概要
システムの構築、運用、保守に必要な手順書とガイドラインを提供し、安定した運用を支援します。

## セットアップガイド

### 環境構築手順書

#### 前提条件
```markdown
# 必要なソフトウェア

## 必須
- Java 21+ (OpenJDK推奨)
- Docker 24.0+
- Docker Compose 2.20+
- Git 2.30+

## 推奨
- IntelliJ IDEA または VS Code
- PostgreSQL クライアント (pgAdmin4, DBeaver等)
- Postman または curl (API テスト用)

## システム要件
- メモリ: 8GB以上
- ディスク容量: 20GB以上の空き容量
- OS: Windows 10+, macOS 12+, Ubuntu 20.04+
```

#### 開発環境セットアップ
```bash
# 1. リポジトリのクローン
git clone https://github.com/readscape-jp/readscape-api.git
cd readscape-api

# 2. 環境変数の設定
cp .env.example .env
# .env ファイルを編集して環境に応じた値を設定

# 3. Docker環境の起動
docker-compose up -d

# 4. データベース接続確認
docker-compose exec postgres psql -U readscape_user -d readscape -c "SELECT version();"

# 5. アプリケーションの起動
cd backend
./gradlew bootRun

# 6. 動作確認
curl http://localhost:8080/api/actuator/health
```

#### 本番環境セットアップ
```bash
# 1. サーバー設定
sudo apt update && sudo apt upgrade -y
sudo apt install openjdk-21-jdk postgresql-client nginx

# 2. アプリケーションデプロイ
sudo useradd -r -s /bin/false readscape
sudo mkdir -p /opt/readscape
sudo chown readscape:readscape /opt/readscape

# 3. データベースセットアップ
# PostgreSQL サーバーの設定（別サーバー推奨）
sudo -u postgres createdb readscape_prod
sudo -u postgres createuser readscape_prod_user

# 4. SSL証明書設定
sudo certbot --nginx -d api.readscape.jp

# 5. システムサービス登録
sudo systemctl enable readscape-api
sudo systemctl start readscape-api
```

### トラブルシューティング
```markdown
# よくある問題と解決方法

## データベース接続エラー
**症状**: `Connection refused` エラー
**原因**: PostgreSQL が起動していない、または接続設定が間違っている
**解決方法**:
1. PostgreSQL の起動確認: `docker-compose ps`
2. ポート確認: `netstat -an | grep 5432`
3. 設定ファイル確認: `application-*.yml` の DB設定

## メモリ不足エラー
**症状**: `OutOfMemoryError`
**原因**: JVM ヒープメモリ不足
**解決方法**:
```bash
# JVM オプションの調整
export JAVA_OPTS="-Xms512m -Xmx2048m"
./gradlew bootRun
```

## ポート競合エラー
**症状**: `Port already in use`
**原因**: 8080番ポートが他のプロセスで使用中
**解決方法**:
```bash
# ポート使用プロセスの確認・停止
lsof -i :8080
kill -9 <PID>
```
```

## DBマイグレーション手順

### マイグレーション実行手順
```bash
# 1. 現在のマイグレーション状態確認
./gradlew flywayInfo

# 2. 保留中のマイグレーション確認
./gradlew flywayValidate

# 3. マイグレーション実行
./gradlew flywayMigrate

# 4. マイグレーション結果確認
./gradlew flywayInfo
```

### マイグレーションファイル作成規約
```sql
-- ファイル名: V{version}__{description}.sql
-- 例: V0009__add_book_isbn_index.sql

-- インデックス追加の例
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_books_isbn 
ON readscape.books(isbn);

-- テーブル追加の例  
CREATE TABLE IF NOT EXISTS readscape.book_categories (
    id SERIAL PRIMARY KEY,
    book_id INTEGER NOT NULL REFERENCES readscape.books(id),
    category_id INTEGER NOT NULL REFERENCES readscape.categories(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(book_id, category_id)
);
```

### ロールバック手順
```bash
# 1. 現在のバージョン確認
./gradlew flywayInfo

# 2. 特定バージョンまでロールバック（本番環境では慎重に実行）
./gradlew flywayUndo -Pflyway.target=V0008

# 3. データベースの整合性確認
./gradlew flywayValidate
```

### マイグレーション失敗時の復旧
```bash
# 1. 失敗したマイグレーションの確認
./gradlew flywayInfo

# 2. 手動でのマイグレーション状態修復
./gradlew flywayRepair

# 3. 問題のあるマイグレーションファイルの修正後、再実行
./gradlew flywayMigrate
```

## ビルド・デプロイ手順

### ローカルビルド手順
```bash
# 1. テスト実行（必須）
./gradlew test

# 2. 静的解析実行
./gradlew checkstyleMain spotbugsMain

# 3. パッケージ作成
./gradlew bootJar

# 4. ビルド成果物確認
ls -la build/libs/readscape-api-*.jar
```

### CI/CDパイプライン設定例
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
      - name: Run tests
        run: ./gradlew test
      - name: Generate test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: 'build/test-results/test/TEST-*.xml'
          reporter: java-junit

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Build JAR
        run: ./gradlew bootJar
      - name: Deploy to server
        run: |
          scp build/libs/readscape-api-*.jar user@production-server:/opt/readscape/
          ssh user@production-server 'sudo systemctl restart readscape-api'
```

### デプロイメント確認手順
```bash
# 1. アプリケーション起動確認
sudo systemctl status readscape-api

# 2. ヘルスチェック
curl -f http://localhost:8080/api/actuator/health

# 3. データベース接続確認
curl -f http://localhost:8080/api/actuator/health/db

# 4. 基本機能動作確認
curl -f http://localhost:8080/api/books?page=0&size=1

# 5. ログ確認
sudo journalctl -u readscape-api -f
```

## 監視・メンテナンス手順

### 日次監視項目
```markdown
# 監視チェックリスト

## システム監視
- [ ] アプリケーション稼働状況
- [ ] CPU・メモリ使用率
- [ ] ディスク使用量
- [ ] ネットワーク接続状況

## データベース監視
- [ ] データベース接続数
- [ ] 長時間実行クエリの有無
- [ ] デッドロックの発生状況
- [ ] バックアップ完了状況

## セキュリティ監視
- [ ] 異常なアクセスパターン
- [ ] 認証失敗ログ
- [ ] SSL証明書有効期限
- [ ] セキュリティアップデート確認
```

### バックアップ手順
```bash
# データベースバックアップ
#!/bin/bash
# backup-db.sh

BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="readscape_prod"

# バックアップ実行
pg_dump -h localhost -U readscape_prod_user -d $DB_NAME > $BACKUP_DIR/readscape_$DATE.sql

# 古いバックアップファイルの削除（30日以上前）
find $BACKUP_DIR -name "readscape_*.sql" -mtime +30 -delete

# バックアップ結果の確認
if [ $? -eq 0 ]; then
    echo "Backup completed successfully: readscape_$DATE.sql"
else
    echo "Backup failed" >&2
    exit 1
fi
```

### リストア手順
```bash
# データベースリストア
#!/bin/bash
# restore-db.sh

BACKUP_FILE=$1
DB_NAME="readscape_prod"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

# データベース停止・作成
sudo systemctl stop readscape-api
dropdb -U readscape_prod_user $DB_NAME
createdb -U readscape_prod_user $DB_NAME

# リストア実行
psql -U readscape_prod_user -d $DB_NAME < $BACKUP_FILE

# アプリケーション再起動
sudo systemctl start readscape-api

echo "Restore completed"
```

### パフォーマンス最適化手順
```sql
-- データベース統計更新
ANALYZE;

-- インデックス使用状況確認
SELECT 
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'readscape'
ORDER BY idx_scan DESC;

-- 未使用インデックスの確認
SELECT 
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE schemaname = 'readscape' 
AND idx_scan = 0;

-- 長時間実行中のクエリ確認
SELECT 
    pid,
    state,
    query,
    query_start
FROM pg_stat_activity
WHERE state = 'active'
AND query_start < now() - interval '5 minutes';
```

## 技術仕様
- 文書管理: Markdown + Git
- 自動化: Shell Script + systemd
- 監視: Spring Boot Actuator + 外部監視ツール
- バックアップ: pg_dump + cron
- デプロイ: GitHub Actions + SSH