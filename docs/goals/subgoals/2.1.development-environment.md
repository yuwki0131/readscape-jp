# 2.1 開発環境

## 概要
Docker を活用したコンテナ化開発環境により、一貫性のある開発体験を提供します。

## Docker構成

### アーキテクチャ
- アプリケーションコンテナ: Spring Boot アプリケーション
- データベースコンテナ: PostgreSQL 15
- 開発ツールコンテナ: pgAdmin4（データベース管理）
- リバースプロキシ: Nginx（本番環境用）

### docker-compose.yml設計
```yaml
version: '3.8'
services:
  app:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=postgres
    depends_on:
      - postgres
    volumes:
      - ./backend:/app
      - gradle_cache:/home/gradle/.gradle

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: readscape
      POSTGRES_USER: readscape_user
      POSTGRES_PASSWORD: readscape_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/config/postgres:/docker-entrypoint-initdb.d

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@readscape.jp
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8081:80"
    depends_on:
      - postgres

volumes:
  postgres_data:
  gradle_cache:
```

### 開発用Dockerfile
```dockerfile
FROM openjdk:21-jdk-slim

WORKDIR /app

# Gradle Wrapper のコピー
COPY gradlew .
COPY gradle gradle/
COPY build.gradle .
COPY settings.gradle .

# 依存関係の事前ダウンロード
RUN ./gradlew dependencies --no-daemon

# ソースコードのコピー
COPY src src/

# アプリケーションのビルドと実行
CMD ["./gradlew", "bootRun", "--no-daemon"]
```

## データベース設定

### PostgreSQL設定
```conf
# postgresql.conf の主要設定
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
```

### 初期化スクリプト
```sql
-- init.sql
-- データベースとユーザーの作成
CREATE DATABASE readscape;
CREATE USER readscape_user WITH ENCRYPTED PASSWORD 'readscape_pass';
GRANT ALL PRIVILEGES ON DATABASE readscape TO readscape_user;

-- 開発用データベース
CREATE DATABASE readscape_dev;
GRANT ALL PRIVILEGES ON DATABASE readscape_dev TO readscape_user;

-- テスト用データベース  
CREATE DATABASE readscape_test;
GRANT ALL PRIVILEGES ON DATABASE readscape_test TO readscape_user;
```

## ビルド設定

### Gradle設定（build.gradle）
```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.0'
    id 'io.spring.dependency-management' version '1.1.4'
    id 'org.flywaydb.flyway' version '9.22.3'
}

group = 'jp.readscape'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '21'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.flywaydb:flyway-core'
    runtimeOnly 'org.postgresql:postgresql'
    
    // 開発用ツール
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    
    // テスト依存関係
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'org.testcontainers:postgresql'
}

// Flyway設定
flyway {
    url = 'jdbc:postgresql://localhost:5432/readscape'
    user = 'readscape_user'
    password = 'readscape_pass'
    schemas = ['readscape']
    locations = ['filesystem:../infrastructure/database/migrations']
}
```

### Gradle Wrapper設定
- Gradle バージョン: 8.5
- 配布URL: `https://services.gradle.org/distributions/gradle-8.5-bin.zip`
- JVM 最大メモリ: `-Xmx2048m`

## 開発ツール統合

### IDE設定（推奨）
- IntelliJ IDEA Ultimate または Community
- VS Code + Extension Pack for Java
- Eclipse IDE for Enterprise Java

### 必要な設定
```properties
# IDE用 application-dev.properties
spring.datasource.url=jdbc:postgresql://localhost:5432/readscape_dev
spring.datasource.username=readscape_user
spring.datasource.password=readscape_pass

spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

logging.level.jp.readscape=DEBUG
logging.level.org.springframework.security=DEBUG
```

### ホットリロード設定
- Spring Boot DevTools 有効化
- 自動再起動機能
- LiveReload サポート
- 設定プロパティのリフレッシュ

## 環境管理

### プロファイル構成
- `default`: ローカル開発環境
- `docker`: Docker コンテナ内実行
- `test`: テスト実行環境
- `prod`: 本番環境

### 環境変数管理
```bash
# .env ファイル例
DB_HOST=localhost
DB_PORT=5432
DB_NAME=readscape
DB_USER=readscape_user
DB_PASSWORD=readscape_pass
JWT_SECRET=your-jwt-secret-key
```

## セットアップ手順

### 前提条件
- Docker 24.0+
- Docker Compose 2.20+
- Java 21+
- Git 2.30+

### 初期セットアップ
```bash
# 1. リポジトリクローン
git clone https://github.com/your-org/readscape-jp.git
cd readscape-jp

# 2. Docker環境起動
docker-compose up -d

# 3. データベースマイグレーション
cd backend
./gradlew flywayMigrate

# 4. アプリケーション起動
./gradlew bootRun
```

### 開発用コマンド
```bash
# データベース初期化
docker-compose exec postgres psql -U readscape_user -d readscape -f /docker-entrypoint-initdb.d/init.sql

# ログ確認
docker-compose logs -f app

# テスト実行
./gradlew test

# パッケージ作成
./gradlew build
```

## 技術仕様
- コンテナ: Docker 24.0+ & Docker Compose 2.20+
- Java: OpenJDK 21
- ビルドツール: Gradle 8.5
- データベース: PostgreSQL 15
- 開発サーバー: Spring Boot Embedded Tomcat