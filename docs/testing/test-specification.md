# Readscape-JP Consumer API 包括的テスト仕様書

## 概要
Readscape-JP Consumer API の機能を検証するための包括的なテスト仕様書です。
実装されている全60+エンドポイントを対象とした完全なテストスイートです。

## テスト環境
- **Base URL**: `http://localhost:8080`
- **認証方式**: JWT認証（Bearer Token）
- **テストデータ**: `data.sql`に定義されたサンプルデータを使用
- **データベース**: H2インメモリDB（dev環境）

## テストユーザー
| ユーザー | メール | パスワード | ロール | 用途 |
|---------|--------|-----------|-------|------|
| consumer1 | consumer1@readscape.jp | hello | CONSUMER | 通常ユーザー機能テスト |
| manager1 | manager1@readscape.jp | hello | MANAGER | マネージャー機能テスト |
| admin1 | admin1@readscape.jp | hello | ADMIN | 管理者機能テスト |

## テストケース一覧

## 🔐 1. 認証・セキュリティ機能テスト

### 1.1 JWT認証（AuthController）

#### 1.1.1 ユーザーログイン（成功）
- **エンドポイント**: `POST /api/auth/login`
- **目的**: 有効な認証情報でJWTトークン（access + refresh）を取得
- **テストデータ**:
  ```json
  {"usernameOrEmail": "consumer1", "password": "hello"}
  ```
- **期待結果**:
  - ステータスコード: 200
  - レスポンスに`accessToken`, `refreshToken`, `tokenType`, `expiresIn`, `user`が含まれる
  - tokenTypeが"Bearer"である

#### 1.1.2 無効なログイン（認証失敗）
- **エンドポイント**: `POST /api/auth/login`
- **目的**: 無効な認証情報でエラーレスポンスを確認
- **テストデータ**:
  ```json
  {"usernameOrEmail": "invalid_user", "password": "wrong_password"}
  ```
- **期待結果**:
  - ステータスコード: 401
  - エラーメッセージ: "ユーザー名またはパスワードが正しくありません"

#### 1.1.3 トークン更新（成功）
- **エンドポイント**: `POST /api/auth/refresh`
- **目的**: 有効なリフレッシュトークンで新しいアクセストークンを取得
- **前提条件**: 事前にログインしてリフレッシュトークンを取得
- **テストデータ**:
  ```json
  {"refreshToken": "{valid_refresh_token}"}
  ```
- **期待結果**:
  - ステータスコード: 200
  - 新しい`accessToken`と`refreshToken`が返される（トークンローテーション）

#### 1.1.4 無効なトークン更新
- **エンドポイント**: `POST /api/auth/refresh`
- **目的**: 無効なリフレッシュトークンでエラーを確認
- **テストデータ**:
  ```json
  {"refreshToken": "invalid_token"}
  ```
- **期待結果**:
  - ステータスコード: 401
  - エラーメッセージ: "無効なリフレッシュトークンです"

#### 1.1.5 ログアウト
- **エンドポイント**: `POST /api/auth/logout`
- **目的**: トークンを無効化してログアウト
- **認証**: 必須（Authorizationヘッダー）
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "ログアウトしました"

### 1.2 ユーザー管理（UsersController）

#### 1.2.1 ユーザー登録（成功）
- **エンドポイント**: `POST /api/users/register`
- **目的**: 新規ユーザーを正常に登録
- **テストデータ**:
  ```json
  {
    "username": "newuser123",
    "email": "newuser@test.com",
    "password": "SecurePass123!"
  }
  ```
- **期待結果**:
  - ステータスコード: 201
  - 成功メッセージ: "ユーザー登録が完了しました"

#### 1.2.2 重複ユーザー名登録（失敗）
- **エンドポイント**: `POST /api/users/register`
- **目的**: 既存ユーザー名での登録エラーを確認
- **テストデータ**:
  ```json
  {
    "username": "consumer1",
    "email": "different@test.com",
    "password": "SecurePass123!"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - エラーメッセージに重複エラーが含まれる

#### 1.2.3 ユーザー名重複チェック
- **エンドポイント**: `GET /api/users/check-username?username=consumer1`
- **目的**: 既存ユーザー名の重複チェック
- **期待結果**:
  - ステータスコード: 409
  - エラーメッセージ: "ユーザー名が既に使用されています"

#### 1.2.4 メール重複チェック
- **エンドポイント**: `GET /api/users/check-email?email=consumer1@readscape.jp`
- **目的**: 既存メールアドレスの重複チェック
- **期待結果**:
  - ステータスコード: 409
  - エラーメッセージ: "メールアドレスが既に使用されています"

#### 1.2.5 新規ユーザー名の可用性チェック
- **エンドポイント**: `GET /api/users/check-username?username=available_user`
- **目的**: 利用可能なユーザー名の確認
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "ユーザー名は利用可能です"

### 1.3 認証制御テスト

#### 1.3.1 未認証アクセス（403エラー）
- **エンドポイント**: `GET /api/cart`
- **目的**: JWTトークンなしでのアクセス時のエラー確認
- **期待結果**:
  - ステータスコード: 403
  - 認証エラーメッセージ

#### 1.3.2 無効なJWTトークン
- **エンドポイント**: `GET /api/cart`
- **認証ヘッダー**: `Bearer invalid_jwt_token`
- **目的**: 無効なJWTでのアクセス拒否確認
- **期待結果**:
  - ステータスコード: 403
  - JWT認証エラー

#### 1.3.3 期限切れJWTトークン
- **エンドポイント**: `GET /api/cart`
- **認証ヘッダー**: `Bearer {expired_token}`
- **目的**: 期限切れトークンでのアクセス拒否確認
- **期待結果**:
  - ステータスコード: 403
  - トークン期限切れエラー

## 📚 2. 書籍閲覧機能テスト（BooksController）

### 2.1 基本書籍API

#### 2.1.1 書籍一覧取得（デフォルト）
- **エンドポイント**: `GET /books`
- **目的**: デフォルト設定での書籍一覧取得
- **期待結果**:
  - ステータスコード: 200
  - レスポンス形式: BooksResponse（books配列、ページネーション情報）
  - 各書籍に必須フィールド（id, title, author, price, category, rating）が含まれる
  - デフォルトソート：newest（作成日時降順）

#### 2.1.2 書籍一覧取得（ページネーション）
- **エンドポイント**: `GET /books?page=0&size=3`
- **目的**: ページネーション機能の確認
- **期待結果**:
  - ステータスコード: 200
  - 最大3件の書籍が返される
  - ページング情報（totalElements, totalPages, size, number）が含まれる

#### 2.1.3 書籍一覧取得（カテゴリーフィルタ）
- **エンドポイント**: `GET /books?category=技術書`
- **目的**: カテゴリーでフィルタリングした書籍一覧の取得
- **期待結果**:
  - ステータスコード: 200
  - "技術書"カテゴリーの書籍のみが返される

#### 2.1.4 書籍一覧取得（キーワード検索）
- **エンドポイント**: `GET /books?keyword=Spring`
- **目的**: キーワードで検索した書籍一覧の取得（タイトル・著者名対象）
- **期待結果**:
  - ステータスコード: 200
  - "Spring"を含む書籍のみが返される

#### 2.1.5 書籍一覧取得（ソート機能）
- **エンドポイント**: `GET /books?sortBy=price_asc`
- **目的**: 価格昇順でのソート確認
- **期待結果**:
  - ステータスコード: 200
  - 書籍が価格の昇順で返される

#### 2.1.6 書籍一覧取得（複合検索）
- **エンドポイント**: `GET /books?category=技術書&keyword=Java&page=0&size=5&sortBy=rating`
- **目的**: カテゴリー、キーワード、ページング、ソートの組み合わせ
- **期待結果**:
  - ステータスコード: 200
  - 条件に合致する書籍が評価順で返される

#### 2.1.7 書籍詳細取得（正常）
- **エンドポイント**: `GET /books/1`
- **目的**: 指定IDの書籍詳細情報を取得
- **期待結果**:
  - ステータスコード: 200
  - 書籍詳細情報（id, title, author, price, category, description, isbn, stock, rating）が含まれる

#### 2.1.8 存在しない書籍詳細取得
- **エンドポイント**: `GET /books/999`
- **目的**: 存在しない書籍IDでのエラーレスポンス確認
- **期待結果**:
  - ステータスコード: 404

### 2.2 書籍検索機能

#### 2.2.1 キーワード検索
- **エンドポイント**: `GET /books/search?q=Java`
- **目的**: 専用検索エンドポイントでのキーワード検索
- **期待結果**:
  - ステータスコード: 200
  - "Java"を含むタイトルまたは著者名の書籍が返される

#### 2.2.2 キーワード検索（カテゴリー絞込み）
- **エンドポイント**: `GET /books/search?q=Spring&category=技術書`
- **目的**: キーワード検索とカテゴリーフィルターの組み合わせ
- **期待結果**:
  - ステータスコード: 200
  - "技術書"カテゴリー内で"Spring"を含む書籍のみ返される

#### 2.2.3 キーワード検索（空文字）
- **エンドポイント**: `GET /books/search?q=`
- **目的**: 必須パラメーターの空文字でのバリデーションエラー確認
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

#### 2.2.4 ISBN検索（正常）
- **エンドポイント**: `GET /books/isbn/9784000000001`
- **目的**: ISBNによる書籍検索
- **期待結果**:
  - ステータスコード: 200
  - 指定ISBNの書籍詳細が返される

#### 2.2.5 ISBN検索（存在しないISBN）
- **エンドポイント**: `GET /books/isbn/9999999999999`
- **目的**: 存在しないISBNでのエラー確認
- **期待結果**:
  - ステータスコード: 404

### 2.3 カテゴリー・特集書籍機能

#### 2.3.1 カテゴリー一覧取得
- **エンドポイント**: `GET /books/categories`
- **目的**: 利用可能な全カテゴリー一覧を取得
- **期待結果**:
  - ステータスコード: 200
  - カテゴリー名の配列（例：["技術書", "ビジネス書", "デザイン"]）が返される

#### 2.3.2 人気書籍一覧取得
- **エンドポイント**: `GET /books/popular`
- **目的**: レビュー数の多い人気書籍を取得
- **期待結果**:
  - ステータスコード: 200
  - デフォルト10件の人気書籍リストが返される

#### 2.3.3 人気書籍一覧取得（件数指定）
- **エンドポイント**: `GET /books/popular?limit=5`
- **目的**: 指定件数の人気書籍を取得
- **期待結果**:
  - ステータスコード: 200
  - 最大5件の人気書籍が返される

#### 2.3.4 評価の高い書籍一覧取得
- **エンドポイント**: `GET /books/top-rated`
- **目的**: 平均評価の高い書籍を取得
- **期待結果**:
  - ステータスコード: 200
  - 評価順に並んだ書籍リストが返される

#### 2.3.5 評価の高い書籍一覧取得（件数指定）
- **エンドポイント**: `GET /books/top-rated?limit=8`
- **目的**: 指定件数の高評価書籍を取得
- **期待結果**:
  - ステータスコード: 200
  - 最大8件の高評価書籍が返される

#### 2.3.6 在庫のある書籍一覧取得
- **エンドポイント**: `GET /books/in-stock`
- **目的**: 在庫のある書籍のみを取得
- **期待結果**:
  - ステータスコード: 200
  - 在庫数 > 0の書籍のみが返される

#### 2.3.7 在庫のある書籍一覧取得（ページング）
- **エンドポイント**: `GET /books/in-stock?page=1&size=5`
- **目的**: 在庫書籍のページング機能確認
- **期待結果**:
  - ステータスコード: 200
  - 2ページ目の在庫書籍（最大5件）が返される

### 2.4 書籍API境界値・エラーテスト

#### 2.4.1 無効なページ番号
- **エンドポイント**: `GET /books?page=-1`
- **目的**: 負の値でのバリデーションエラー確認
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

#### 2.4.2 無効なページサイズ
- **エンドポイント**: `GET /books?size=0`
- **目的**: 無効なサイズ値でのバリデーションエラー確認
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

#### 2.4.3 無効なソート条件
- **エンドポイント**: `GET /books?sortBy=invalid_sort`
- **目的**: 無効なソート条件での処理確認
- **期待結果**:
  - ステータスコード: 200
  - デフォルトソート（newest）が適用される

#### 2.4.4 無効な書籍ID（文字列）
- **エンドポイント**: `GET /books/invalid_id`
- **目的**: 数値以外のIDでのエラー確認
- **期待結果**:
  - ステータスコード: 400
  - パラメーター型エラー

## 🛒 3. カート機能テスト（CartsController）- 全て認証必須

### 3.1 カート基本操作

#### 3.1.1 カート内容取得（空のカート）
- **エンドポイント**: `GET /api/cart`
- **目的**: 新規ユーザーの空カート状態確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - カート情報（items=[], totalPrice=0）が返される

#### 3.1.2 カートに書籍追加（新規追加）
- **エンドポイント**: `POST /api/cart`
- **目的**: カートに新しい書籍を追加
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"bookId": 1, "quantity": 2}
  ```
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "商品をカートに追加しました"

#### 3.1.3 カート内容取得（商品追加後）
- **エンドポイント**: `GET /api/cart`
- **目的**: 商品追加後のカート状態確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - カート情報にbookId=1, quantity=2の商品が含まれる
  - totalPriceが正しく計算されている

#### 3.1.4 カートに書籍追加（重複商品）
- **エンドポイント**: `POST /api/cart`
- **目的**: 既存商品を再度追加した場合の数量増加確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"bookId": 1, "quantity": 1}
  ```
- **期待結果**:
  - ステータスコード: 200
  - 既存商品の数量が3（2+1）に更新される

#### 3.1.5 カート内書籍数量変更
- **エンドポイント**: `PUT /api/cart/1`
- **目的**: カート内の書籍数量を直接変更
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"quantity": 5}
  ```
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "カート内商品の数量を変更しました"

#### 3.1.6 複数商品をカートに追加
- **エンドポイント**: `POST /api/cart`（複数回実行）
- **目的**: 複数種類の書籍をカートに追加
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"bookId": 2, "quantity": 1}
  {"bookId": 3, "quantity": 3}
  ```
- **期待結果**:
  - 各リクエストでステータスコード: 200
  - カートに複数商品が格納される

#### 3.1.7 カートから書籍削除
- **エンドポイント**: `DELETE /api/cart/1`
- **目的**: カートから指定書籍を削除
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "商品をカートから削除しました"

#### 3.1.8 カートを空にする
- **エンドポイント**: `DELETE /api/cart`
- **目的**: カート内のすべての商品を削除
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "カートを空にしました"

### 3.2 カートエラーケーステスト

#### 3.2.1 存在しない書籍をカートに追加
- **エンドポイント**: `POST /api/cart`
- **目的**: 存在しない書籍IDでのエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"bookId": 999, "quantity": 1}
  ```
- **期待結果**:
  - ステータスコード: 400 または 404
  - エラーメッセージ

#### 3.2.2 無効な数量でカートに追加
- **エンドポイント**: `POST /api/cart`
- **目的**: 0以下の数量でのバリデーションエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"bookId": 1, "quantity": 0}
  ```
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

#### 3.2.3 存在しない商品の数量変更
- **エンドポイント**: `PUT /api/cart/999`
- **目的**: カートに存在しない商品の数量変更でのエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {"quantity": 2}
  ```
- **期待結果**:
  - ステータスコード: 404
  - エラーメッセージ

#### 3.2.4 存在しない商品の削除
- **エンドポイント**: `DELETE /api/cart/999`
- **目的**: カートに存在しない商品削除でのエラー確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 404
  - エラーメッセージ

### 3.3 カート認証テスト

#### 3.3.1 未認証でのカートアクセス
- **エンドポイント**: `GET /api/cart`
- **目的**: 未認証ユーザーのアクセス拒否確認
- **認証**: なし
- **期待結果**:
  - ステータスコード: 403
  - 認証エラーメッセージ

#### 3.3.2 無効な権限でのカートアクセス
- **エンドポイント**: `GET /api/cart`
- **目的**: CONSUMER権限以外でのアクセス制御確認
- **認証**: MANAGER権限のユーザー
- **期待結果**:
  - ステータスコード: 403 または正常アクセス（権限設計による）

## 📦 4. 注文機能テスト（OrdersController）- 全て認証必須

### 4.1 注文作成機能

#### 4.1.1 注文作成（成功）
- **エンドポイント**: `POST /api/orders`
- **目的**: カート内商品から正常に注文を作成
- **認証**: 必須（CONSUMER権限）
- **前提条件**: カートに商品が追加済み
- **テストデータ**:
  ```json
  {
    "paymentMethod": "credit_card",
    "shippingAddress": "東京都渋谷区1-2-3"
  }
  ```
- **期待結果**:
  - ステータスコード: 201
  - CreateOrderResponse（orderNumber, totalAmount等）が返される
  - カートが自動的にクリアされる

#### 4.1.2 空カートでの注文作成（失敗）
- **エンドポイント**: `POST /api/orders`
- **目的**: 空カートでの注文作成エラー確認
- **認証**: 必須（CONSUMER権限）
- **前提条件**: 空のカート
- **テストデータ**:
  ```json
  {
    "paymentMethod": "credit_card",
    "shippingAddress": "東京都渋谷区1-2-3"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - エラーメッセージ: "カートが空です"

#### 4.1.3 在庫不足での注文作成（失敗）
- **エンドポイント**: `POST /api/orders`
- **目的**: 在庫不足商品での注文エラー確認
- **認証**: 必須（CONSUMER権限）
- **前提条件**: 在庫不足商品がカートに含まれる
- **期待結果**:
  - ステータスコード: 409
  - エラーメッセージに在庫不足の詳細

#### 4.1.4 無効な決済方法での注文作成
- **エンドポイント**: `POST /api/orders`
- **目的**: 無効な決済方法でのバリデーションエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "paymentMethod": "invalid_method",
    "shippingAddress": "東京都渋谷区1-2-3"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

### 4.2 注文履歴・詳細取得

#### 4.2.1 注文履歴取得（OrdersController）
- **エンドポイント**: `GET /api/orders`
- **目的**: 認証ユーザーの注文履歴を全件取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - OrderSummary配列（注文概要情報）が返される
  - 新しい注文順で並んでいる

#### 4.2.2 注文履歴取得（UsersController）
- **エンドポイント**: `GET /api/users/orders`
- **目的**: ユーザーコントローラー経由での注文履歴取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - 同じ注文履歴データが返される

#### 4.2.3 注文詳細取得（成功）
- **エンドポイント**: `GET /api/orders/{orderId}`
- **目的**: 指定注文の詳細情報を取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - OrderDetail（注文詳細、商品一覧、配送先等）が返される

#### 4.2.4 他人の注文詳細取得（失敗）
- **エンドポイント**: `GET /api/orders/{other_user_order_id}`
- **目的**: 他ユーザーの注文へのアクセス制御確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 404 または 403
  - アクセス拒否メッセージ

#### 4.2.5 存在しない注文詳細取得
- **エンドポイント**: `GET /api/orders/999`
- **目的**: 存在しない注文IDでのエラー確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 404

### 4.3 最近の注文・統計情報

#### 4.3.1 最近の注文取得（デフォルト）
- **エンドポイント**: `GET /api/orders/recent`
- **目的**: 最近の5件の注文を取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - 最大5件のOrderSummary配列が返される

#### 4.3.2 最近の注文取得（件数指定）
- **エンドポイント**: `GET /api/orders/recent?limit=3`
- **目的**: 指定件数の最近の注文を取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - 最大3件の注文が返される

#### 4.3.3 注文統計取得
- **エンドポイント**: `GET /api/orders/statistics`
- **目的**: ユーザーの注文統計情報を取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - OrderStatistics（注文回数、合計金額等）が返される

### 4.4 注文キャンセル機能

#### 4.4.1 注文キャンセル（成功）
- **エンドポイント**: `POST /api/orders/{orderId}/cancel`
- **目的**: キャンセル可能な注文を正常にキャンセル
- **認証**: 必須（CONSUMER権限）
- **前提条件**: キャンセル可能状態の注文
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: "注文をキャンセルしました"

#### 4.4.2 キャンセル不可注文のキャンセル（失敗）
- **エンドポイント**: `POST /api/orders/{shipped_order_id}/cancel`
- **目的**: キャンセル不可状態の注文でのエラー確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 400
  - エラーメッセージ: "キャンセル不可能な注文です"

#### 4.4.3 他人の注文キャンセル（失敗）
- **エンドポイント**: `POST /api/orders/{other_user_order_id}/cancel`
- **目的**: 他ユーザー注文のキャンセル防止確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 404
  - アクセス拒否

## 👤 5. ユーザープロフィール機能テスト（UsersController）- 認証必須

### 5.1 プロフィール管理

#### 5.1.1 プロフィール取得（成功）
- **エンドポイント**: `GET /api/users/profile`
- **目的**: 認証済みユーザーのプロフィール情報を取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - UserProfile（username, email, createdAt等）が返される

#### 5.1.2 プロフィール更新（成功）
- **エンドポイント**: `PUT /api/users/profile`
- **目的**: ユーザープロフィール情報の更新
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "username": "updated_consumer",
    "email": "updated_consumer@readscape.jp"
  }
  ```
- **期待結果**:
  - ステータスコード: 200
  - 更新されたUserProfileが返される

#### 5.1.3 プロフィール更新（重複ユーザー名）
- **エンドポイント**: `PUT /api/users/profile`
- **目的**: 既存ユーザー名への更新エラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "username": "consumer1",
    "email": "newemail@test.com"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - エラーメッセージに重複エラー

#### 5.1.4 無効なメールでプロフィール更新
- **エンドポイント**: `PUT /api/users/profile`
- **目的**: 無効なメールフォーマットでのバリデーションエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "username": "validuser",
    "email": "invalid-email-format"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

## ⭐ 6. レビュー機能テスト（ReviewsController）

### 6.1 レビュー閲覧機能（認証不要）

#### 6.1.1 書籍レビュー一覧取得（デフォルト）
- **エンドポイント**: `GET /api/books/1/reviews`
- **目的**: 指定書籍のレビュー一覧を取得
- **期待結果**:
  - ステータスコード: 200
  - BookReviewsResponse（reviews配列、ページング情報）が返される

#### 6.1.2 レビュー一覧取得（ページング）
- **エンドポイント**: `GET /api/books/1/reviews?page=0&size=5`
- **目的**: ページング機能付きレビュー取得
- **期待結果**:
  - ステータスコード: 200
  - 最大5件のレビューが返される

#### 6.1.3 レビュー一覧取得（ソート）
- **エンドポイント**: `GET /api/books/1/reviews?sortBy=helpful`
- **目的**: 「役立った」順でレビューをソート
- **期待結果**:
  - ステータスコード: 200
  - 役立ったカウント順でレビューが返される

#### 6.1.4 レビュー検索
- **エンドポイント**: `GET /api/books/1/reviews/search?keyword=面白い`
- **目的**: キーワードでレビューを検索
- **期待結果**:
  - ステータスコード: 200
  - 「面白い」を含むレビューのみ返される

#### 6.1.5 存在しない書籍のレビュー取得
- **エンドポイント**: `GET /api/books/999/reviews`
- **目的**: 存在しない書籍IDでのエラー確認
- **期待結果**:
  - ステータスコード: 404

#### 6.1.6 「役立った」マーク追加
- **エンドポイント**: `POST /api/books/1/reviews/1/helpful`
- **目的**: 指定レビューに「役立った」カウントを追加
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: 「『役立った』を追加しました」

### 6.2 レビュー投稿機能（認証必須）

#### 6.2.1 レビュー投稿（成功）
- **エンドポイント**: `POST /api/books/1/reviews`
- **目的**: 書籍に新しいレビューを投稿
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "rating": 5,
    "title": "素晴らしい本",
    "comment": "非常に勉強になりました！"
  }
  ```
- **期待結果**:
  - ステータスコード: 201
  - ReviewResponse（投稿されたレビュー情報）が返される

#### 6.2.2 重複レビュー投稿（失敗）
- **エンドポイント**: `POST /api/books/1/reviews`
- **目的**: 同じ書籍への重複レビュー投稿エラー確認
- **認証**: 必須（CONSUMER権限）
- **前提条件**: 既に同じ書籍にレビュー投稿済み
- **期待結果**:
  - ステータスコード: 409
  - エラーメッセージ: 重複投稿エラー

#### 6.2.3 購入履歴なしレビュー投稿（失敗）
- **エンドポイント**: `POST /api/books/1/reviews`
- **目的**: 購入履歴のない書籍へのレビュー投稿エラー確認
- **認証**: 必須（購入履歴のないCONSUMER）
- **期待結果**:
  - ステータスコード: 409
  - エラーメッセージ: 「購入履歴がある書籍のみレビュー可能」

#### 6.2.4 無効な評価でレビュー投稿
- **エンドポイント**: `POST /api/books/1/reviews`
- **目的**: 範囲外の評価でのバリデーションエラー確認
- **認証**: 必須（CONSUMER権限）
- **テストデータ**:
  ```json
  {
    "rating": 6,
    "title": "タイトル",
    "comment": "コメント"
  }
  ```
- **期待結果**:
  - ステータスコード: 400
  - バリデーションエラーメッセージ

### 6.3 レビュー編集・削除機能（認証必須）

#### 6.3.1 レビュー更新（成功）
- **エンドポイント**: `PUT /api/books/1/reviews/1`
- **目的**: 自分が投稿したレビューを更新
- **認証**: 必須（CONSUMER権限、本人のレビュー）
- **テストデータ**:
  ```json
  {
    "rating": 4,
    "title": "更新されたタイトル",
    "comment": "更新されたコメント"
  }
  ```
- **期待結果**:
  - ステータスコード: 200
  - 更新されたReviewResponseが返される

#### 6.3.2 他人のレビュー更新（失敗）
- **エンドポイント**: `PUT /api/books/1/reviews/{other_user_review_id}`
- **目的**: 他ユーザーのレビュー更新拒否確認
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 403
  - エラーメッセージ: 「他人のレビューは更新できません」

#### 6.3.3 レビュー削除（成功）
- **エンドポイント**: `DELETE /api/books/1/reviews/1`
- **目的**: 自分が投稿したレビューを削除
- **認証**: 必須（CONSUMER権限、本人のレビュー）
- **期待結果**:
  - ステータスコード: 200
  - 成功メッセージ: 「レビューを削除しました」

#### 6.3.4 自分のレビュー一覧取得
- **エンドポイント**: `GET /api/books/reviews/my-reviews`
- **目的**: 認証ユーザーが投稿した全レビューを取得
- **認証**: 必須（CONSUMER権限）
- **期待結果**:
  - ステータスコード: 200
  - ReviewSummary配列（ユーザーの全レビュー）が返される

## 📊 7. ヘルスチェック機能テスト（HealthController）

### 7.1 基本ヘルスチェック

#### 7.1.1 基本ヘルスチェック
- **エンドポイント**: `GET /health`
- **目的**: APIの基本的な動作状態を確認
- **期待結果**:
  - ステータスコード: 200
  - status: "UP", service, timestamp, versionが含まれる

#### 7.1.2 認証システムヘルスチェック
- **エンドポイント**: `GET /health/auth`
- **目的**: 認証システムの詳細ヘルス情報を取得
- **期待結果**:
  - ステータスコード: 200
  - loginAttemptService, tokenBlacklistServiceの状態情報

#### 7.1.3 認証システム統計情報
- **エンドポイント**: `GET /health/auth/stats`
- **目的**: 認証システムの統計情報を取得
- **期待結果**:
  - ステータスコード: 200
  - ブラックリストトークン数、メモリ使用量、稼働時間等

## 🔒 8. 認証・アクセス制御テスト

### 8.1 未認証アクセステスト

#### 8.1.1 認証必須エンドポイントへの未認証アクセス
- **エンドポイント**: `GET /api/cart`
- **目的**: JWTトークンなしでのアクセス時のエラー確認
- **期待結果**:
  - ステータスコード: 403
  - 認証エラーメッセージ

#### 8.1.2 ユーザー管理エンドポイントへの未認証アクセス
- **エンドポイント**: `GET /api/users/profile`
- **目的**: プロフィールアクセスの認証必須確認
- **期待結果**:
  - ステータスコード: 403

#### 8.1.3 注文エンドポイントへの未認証アクセス
- **エンドポイント**: `POST /api/orders`
- **目的**: 注文作成の認証必須確認
- **期待結果**:
  - ステータスコード: 403

#### 8.1.4 レビュー投稿への未認証アクセス
- **エンドポイント**: `POST /api/books/1/reviews`
- **目的**: レビュー投稿の認証必須確認
- **期待結果**:
  - ステータスコード: 403

---

# 📊 テスト実行要領

## テストケース統計

| カテゴリー | テスト項目数 | 説明 |
|-----------|------------|------|
| 🔐 認証・セキュリティ | 18項目 | JWT認証、ユーザー登録、権限制御 |
| 📚 書籍閲覧機能 | 24項目 | 書籍検索、カテゴリー、特集、境界値テスト |
| 🛒 カート機能 | 12項目 | CRUD操作、エラーハンドリング、認証制御 |
| 📦 注文機能 | 17項目 | 注文作成、履歴、統計、キャンセル |
| 👤 ユーザープロフィール | 4項目 | プロフィール管理、バリデーション |
| ⭐ レビューシステム | 15項目 | 閲覧、投稿、編集、削除、認証制御 |
| 📊 ヘルスチェック | 3項目 | 基本、認証システム、統計情報 |
| 🔒 アクセス制御 | 4項目 | 未認証アクセステスト |
| **合計** | **97項目** | **包括的なテストカバレッジ** |

## 検証項目

### 1. レスポンス検証
- **ステータスコード**: 期待されるHTTPステータスコードが返される
- **レスポンス形式**: JSON構造とスキーマの正確性
- **必須フィールド**: 期待されるフィールドが含まれている
- **データ型**: フィールドのデータ型が正しい（String, Integer, Boolean等）
- **データ値**: 期待される値が設定されている
- **日時フォーマット**: ISO 8601形式での日時データ
- **エラーメッセージ**: 適切な日本語エラーメッセージ

### 2. セキュリティ検証
- **認証制御**: 認証が必要なエンドポイントで適切にアクセス制御される
- **JWT検証**:
  - 有効なJWTトークンでのみアクセス可能
  - 期限切れトークンの拒否
  - 無効なトークンの拒否
- **権限制御**: ユーザーロール（CONSUMER, MANAGER, ADMIN）に応じた適切なアクセス制御
- **データアクセス制御**: 他ユーザーのデータへのアクセス拒否
- **入力値検証**: SQLインジェクション、XSS攻撃への対応

### 3. 機能検証
- **CRUD操作**: 作成、読取、更新、削除の各操作が正常に動作
- **検索・フィルタ**:
  - キーワード検索の精度
  - カテゴリーフィルタリング
  - 複合検索条件の処理
- **ページネーション**:
  - 正確な件数制御
  - ページング情報の正確性
  - 境界値での動作
- **ソート機能**: 各種ソート条件での正確な並び順
- **関連性**: エンティティ間の関連性が正しく処理される
- **トランザクション**: データ整合性の保証

### 4. パフォーマンス検証
- **レスポンス時間**: 各エンドポイントの適切なレスポンス時間
- **データベースクエリ**: 効率的なSQLクエリの実行
- **メモリ使用量**: 大量データ処理時のメモリ効率

### 5. エラーハンドリング検証
- **バリデーションエラー**: 入力値検証の適切な実装
- **ビジネスルールエラー**: 業務制約の適切な実装
- **システムエラー**: 例外処理の適切な実装
- **リソースエラー**: 存在しないリソースへのアクセス処理

## テスト実行環境

### 前提条件
1. **アプリケーション起動**: Consumer API (port 8080) が正常に起動している
2. **データベース初期化**: H2インメモリDBにテストデータが投入済み
3. **環境変数**: `SPRING_PROFILES_ACTIVE=dev` が設定済み
4. **ネットワーク**: ローカルホスト接続が可能

### テスト実行順序
1. **ヘルスチェック**: アプリケーションの基本動作確認
2. **認証機能**: JWT取得とユーザー管理機能
3. **書籍閲覧**: 認証不要機能の動作確認
4. **認証付き機能**: カート→注文→レビュー→プロフィール
5. **セキュリティテスト**: 未認証アクセス、権限制御確認

### テストデータ要件
```sql
-- 必要なテストデータ
- 書籍データ: 最低8件（異なるカテゴリー、価格帯、評価）
- ユーザーデータ: CONSUMER、MANAGER、ADMIN各1名以上
- レビューデータ: 各書籍に複数のレビュー
- 注文データ: 各種ステータスの注文履歴
```

## 実行上の注意事項

### 必須要件
- **順序独立**: 各テストケースは独立して実行可能
- **べき等性**: 同じテストを複数回実行しても結果が一致
- **データクリーンアップ**: テスト後のデータ状態を考慮
- **並列実行**: 可能な限り並列実行に対応

### テスト時の考慮事項
1. **認証トークン管理**:
   - テスト開始時にJWTトークンを取得
   - トークン期限切れに対する対応
   - 複数ユーザーでのテスト実行

2. **データ状態管理**:
   - カート内商品の事前クリア
   - テスト用商品の在庫状態確認
   - 他テストとのデータ競合回避

3. **エラーレート許容**:
   - ネットワーク遅延による一時的エラー
   - データベース接続エラー
   - 許容エラー率: 5%以下

### 期待される実行結果
- **成功率**: 95%以上
- **平均レスポンス時間**: 500ms以下
- **メモリ使用量**: 1GB以下
- **データベース接続**: 安定した接続維持

### 推奨実行環境
- **OS**: Linux/macOS/Windows
- **Java**: JDK 21以上
- **メモリ**: 最低2GB RAM
- **ストレージ**: 1GB以上の空き容量