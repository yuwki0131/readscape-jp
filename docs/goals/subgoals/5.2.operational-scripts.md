# 5.2 é‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

## æ¦‚è¦
ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€é‹ç”¨ã«å¿…è¦ãªè‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾¤ã‚’æä¾›ã—ã¾ã™ã€‚

## åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒæ§‹ç¯‰ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/init-project.sh

set -e

PROJECT_NAME="readscape-jp"
PROJECT_DIR="$(pwd)"

echo "ğŸš€ Initializing $PROJECT_NAME development environment..."

# å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
check_prerequisites() {
    echo "ğŸ“‹ Checking prerequisites..."
    
    # Java 21ãƒã‚§ãƒƒã‚¯
    if command -v java >/dev/null 2>&1; then
        JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1)
        if [ "$JAVA_VERSION" -ge 21 ]; then
            echo "âœ… Java $JAVA_VERSION detected"
        else
            echo "âŒ Java 21 or higher required. Current: $JAVA_VERSION"
            exit 1
        fi
    else
        echo "âŒ Java not found. Please install Java 21+"
        exit 1
    fi
    
    # Docker ãƒã‚§ãƒƒã‚¯
    if command -v docker >/dev/null 2>&1; then
        DOCKER_VERSION=$(docker --version | awk '{print $3}' | sed 's/,//')
        echo "âœ… Docker $DOCKER_VERSION detected"
    else
        echo "âŒ Docker not found. Please install Docker 24.0+"
        exit 1
    fi
    
    # Docker Compose ãƒã‚§ãƒƒã‚¯  
    if command -v docker-compose >/dev/null 2>&1; then
        COMPOSE_VERSION=$(docker-compose --version | awk '{print $3}' | sed 's/,//')
        echo "âœ… Docker Compose $COMPOSE_VERSION detected"
    else
        echo "âŒ Docker Compose not found. Please install Docker Compose 2.20+"
        exit 1
    fi
}

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
setup_environment() {
    echo "ğŸ”§ Setting up environment configuration..."
    
    if [ ! -f ".env" ]; then
        cp .env.example .env
        echo "âœ… Created .env file from template"
        echo "âš ï¸  Please edit .env file with your settings"
    else
        echo "â„¹ï¸  .env file already exists"
    fi
}

# Docker ç’°å¢ƒåˆæœŸåŒ–
setup_docker() {
    echo "ğŸ³ Setting up Docker environment..."
    
    # æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ãƒ»å‰Šé™¤
    if docker-compose ps | grep -q "Up"; then
        echo "Stopping existing containers..."
        docker-compose down
    fi
    
    # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
    echo "Building Docker images..."
    docker-compose build --no-cache
    
    # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
    echo "Starting containers..."
    docker-compose up -d
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èµ·å‹•å¾…æ©Ÿ
    echo "Waiting for database to be ready..."
    timeout 60s bash -c 'until docker-compose exec postgres pg_isready -U readscape_user; do sleep 1; done'
    
    if [ $? -eq 0 ]; then
        echo "âœ… Database is ready"
    else
        echo "âŒ Database startup timeout"
        exit 1
    fi
}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
setup_database() {
    echo "ğŸ—„ï¸  Setting up database..."
    
    cd backend
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    echo "Running database migrations..."
    ./gradlew flywayMigrate
    
    if [ $? -eq 0 ]; then
        echo "âœ… Database migrations completed"
    else
        echo "âŒ Database migration failed"
        exit 1
    fi
    
    cd ..
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª
verify_setup() {
    echo "ğŸ” Verifying setup..."
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    cd backend
    echo "Starting application..."
    ./gradlew bootRun > ../logs/app-startup.log 2>&1 &
    APP_PID=$!
    cd ..
    
    # èµ·å‹•å¾…æ©Ÿ
    echo "Waiting for application to start..."
    for i in {1..30}; do
        if curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
            echo "âœ… Application is running"
            kill $APP_PID 2>/dev/null || true
            return 0
        fi
        sleep 2
    done
    
    echo "âŒ Application startup timeout"
    kill $APP_PID 2>/dev/null || true
    exit 1
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    echo "Starting project initialization..."
    
    check_prerequisites
    setup_environment
    setup_docker
    setup_database
    verify_setup
    
    echo ""
    echo "ğŸ‰ Project initialization completed successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. Edit .env file with your configuration"
    echo "  2. Run: cd backend && ./gradlew bootRun"
    echo "  3. Open: http://localhost:8080/api/swagger-ui.html"
    echo ""
}

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p logs

# å®Ÿè¡Œ
main "$@"
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# workscripts/init-backend.sh

set -e

BACKEND_DIR="backend"
GRADLE_WRAPPER="./gradlew"

echo "ğŸ”§ Initializing backend application..."

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
cd "$BACKEND_DIR"

# Gradle Wrapper æ¨©é™è¨­å®š
chmod +x gradlew

# ä¾å­˜é–¢ä¿‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
echo "ğŸ“¦ Downloading dependencies..."
$GRADLE_WRAPPER dependencies --refresh-dependencies

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
echo "ğŸ”¨ Compiling source code..."
$GRADLE_WRAPPER compileJava compileTestJava

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "ğŸ§ª Running tests..."
$GRADLE_WRAPPER test

# é™çš„è§£æ
echo "ğŸ” Running static analysis..."
$GRADLE_WRAPPER checkstyleMain spotbugsMain

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ãƒ†ã‚¹ãƒˆ
echo "ğŸš€ Testing application startup..."
timeout 30s $GRADLE_WRAPPER bootRun --args='--spring.profiles.active=test' || {
    if [ $? -eq 124 ]; then
        echo "âœ… Application startup test completed (timeout expected)"
    else
        echo "âŒ Application startup failed"
        exit 1
    fi
}

echo "âœ… Backend initialization completed!"
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# infrastructure/db/migrate.sh

set -e

# è¨­å®šèª­ã¿è¾¼ã¿
source "$(dirname "$0")/../.env" 2>/dev/null || true

DB_HOST=${DB_HOST:-localhost}
DB_PORT=${DB_PORT:-5432}
DB_NAME=${DB_NAME:-readscape}
DB_USER=${DB_USER:-readscape_user}
DB_PASSWORD=${DB_PASSWORD:-readscape_pass}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
MIGRATION_DIR="$SCRIPT_DIR/migration/sql"

echo "ğŸ—„ï¸  Database Migration Script"
echo "================================"
echo "Host: $DB_HOST:$DB_PORT"
echo "Database: $DB_NAME"
echo "User: $DB_USER"
echo ""

# PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª
if ! command -v psql >/dev/null 2>&1; then
    echo "âŒ psql command not found. Please install PostgreSQL client."
    exit 1
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
test_connection() {
    echo "ğŸ” Testing database connection..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d postgres -c "SELECT version();" >/dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "âœ… Database connection successful"
    else
        echo "âŒ Database connection failed"
        exit 1
    fi
}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
create_database() {
    echo "ğŸ—ï¸  Checking database existence..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$DB_NAME';" | grep -q 1
    
    if [ $? -ne 0 ]; then
        echo "Creating database: $DB_NAME"
        PGPASSWORD=$DB_PASSWORD createdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME
        echo "âœ… Database created"
    else
        echo "â„¹ï¸  Database already exists"
    fi
}

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
create_migration_history() {
    echo "ğŸ“‹ Setting up migration history..."
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
CREATE TABLE IF NOT EXISTS migration_history (
    id SERIAL PRIMARY KEY,
    version VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_time INTERVAL,
    checksum VARCHAR(64)
);
EOF
    
    echo "âœ… Migration history table ready"
}

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
execute_migrations() {
    echo "ğŸš€ Executing migrations..."
    
    for migration_file in $(ls $MIGRATION_DIR/V*.sql | sort -V); do
        filename=$(basename "$migration_file")
        version=$(echo "$filename" | sed 's/V\([0-9]*\)__.*/\1/')
        description=$(echo "$filename" | sed 's/V[0-9]*__\(.*\)\.sql/\1/')
        
        # æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -tc "SELECT 1 FROM migration_history WHERE version = '$version';" | grep -q 1
        
        if [ $? -eq 0 ]; then
            echo "â­ï¸  Skipping $filename (already executed)"
            continue
        fi
        
        echo "ğŸ“ Executing $filename..."
        start_time=$(date +%s)
        
        # ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—
        checksum=$(sha256sum "$migration_file" | awk '{print $1}')
        
        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "$migration_file"
        
        if [ $? -eq 0 ]; then
            end_time=$(date +%s)
            execution_time=$((end_time - start_time))
            
            # å®Ÿè¡Œå±¥æ­´è¨˜éŒ²
            PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
INSERT INTO migration_history (version, description, execution_time, checksum) 
VALUES ('$version', '$description', '$execution_time seconds', '$checksum');
EOF
            echo "âœ… $filename executed successfully (${execution_time}s)"
        else
            echo "âŒ Migration failed: $filename"
            exit 1
        fi
    done
}

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹è¡¨ç¤º
show_migration_status() {
    echo ""
    echo "ğŸ“Š Migration Status:"
    echo "===================="
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME << EOF
SELECT 
    version,
    description,
    executed_at,
    execution_time
FROM migration_history 
ORDER BY version::integer;
EOF
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    case "${1:-migrate}" in
        "migrate")
            test_connection
            create_database
            create_migration_history
            execute_migrations
            show_migration_status
            echo "ğŸ‰ Database migration completed!"
            ;;
        "status")
            test_connection
            show_migration_status
            ;;
        "reset")
            echo "âš ï¸  This will DROP the entire database!"
            read -p "Are you sure? (yes/no): " confirm
            if [ "$confirm" = "yes" ]; then
                PGPASSWORD=$DB_PASSWORD dropdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME --if-exists
                echo "âœ… Database dropped"
                main "migrate"
            else
                echo "Operation cancelled"
            fi
            ;;
        *)
            echo "Usage: $0 [migrate|status|reset]"
            echo "  migrate: Run pending migrations (default)"
            echo "  status:  Show migration status"
            echo "  reset:   Drop and recreate database"
            ;;
    esac
}

# å®Ÿè¡Œ
main "$@"
```

## é‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ãƒ»åœæ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/system-control.sh

set -e

SERVICE_NAME="readscape-api"
APP_DIR="/opt/readscape"
LOG_FILE="/var/log/readscape/system-control.log"
PID_FILE="$APP_DIR/readscape-api.pid"

# ãƒ­ã‚°é–¢æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ãƒ—ãƒ­ã‚»ã‚¹å­˜åœ¨ç¢ºèª
is_running() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        ps -p $PID > /dev/null 2>&1
        return $?
    fi
    return 1
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
start_app() {
    log "Starting $SERVICE_NAME..."
    
    if is_running; then
        log "âš ï¸  $SERVICE_NAME is already running"
        return 0
    fi
    
    # å‰å›ã® PID ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    [ -f "$PID_FILE" ] && rm -f "$PID_FILE"
    
    # systemd ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹•
    if command -v systemctl >/dev/null 2>&1; then
        sudo systemctl start $SERVICE_NAME
        
        # èµ·å‹•ç¢ºèª
        sleep 5
        if systemctl is-active --quiet $SERVICE_NAME; then
            log "âœ… $SERVICE_NAME started successfully"
        else
            log "âŒ Failed to start $SERVICE_NAME"
            return 1
        fi
    else
        # ç›´æ¥èµ·å‹•ï¼ˆsystemd æœªä½¿ç”¨ç’°å¢ƒï¼‰
        cd "$APP_DIR"
        nohup java -jar readscape-api.jar > /dev/null 2>&1 &
        echo $! > "$PID_FILE"
        
        # èµ·å‹•ç¢ºèª
        sleep 10
        if is_running && curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
            log "âœ… $SERVICE_NAME started successfully"
        else
            log "âŒ Failed to start $SERVICE_NAME"
            return 1
        fi
    fi
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
stop_app() {
    log "Stopping $SERVICE_NAME..."
    
    if ! is_running; then
        log "â„¹ï¸  $SERVICE_NAME is not running"
        return 0
    fi
    
    if command -v systemctl >/dev/null 2>&1; then
        sudo systemctl stop $SERVICE_NAME
        log "âœ… $SERVICE_NAME stopped"
    else
        # ç›´æ¥åœæ­¢
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            kill $PID
            
            # æ­£å¸¸çµ‚äº†å¾…æ©Ÿ
            for i in {1..30}; do
                if ! ps -p $PID > /dev/null 2>&1; then
                    rm -f "$PID_FILE"
                    log "âœ… $SERVICE_NAME stopped gracefully"
                    return 0
                fi
                sleep 1
            done
            
            # å¼·åˆ¶çµ‚äº†
            kill -9 $PID 2>/dev/null || true
            rm -f "$PID_FILE"
            log "âš ï¸  $SERVICE_NAME force stopped"
        fi
    fi
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
restart_app() {
    log "Restarting $SERVICE_NAME..."
    stop_app
    sleep 3
    start_app
}

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
status_app() {
    echo "ğŸ” $SERVICE_NAME Status"
    echo "======================="
    
    if command -v systemctl >/dev/null 2>&1; then
        systemctl status $SERVICE_NAME --no-pager
    else
        if is_running; then
            echo "Status: Running"
            echo "PID: $(cat $PID_FILE)"
        else
            echo "Status: Stopped"
        fi
    fi
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    echo ""
    echo "ğŸ¥ Health Check"
    echo "==============="
    
    if curl -f http://localhost:8080/api/actuator/health 2>/dev/null; then
        echo ""
        echo "âœ… Application is healthy"
    else
        echo "âŒ Application health check failed"
    fi
}

# ãƒ­ã‚°è¡¨ç¤º
show_logs() {
    local lines=${1:-100}
    
    if command -v journalctl >/dev/null 2>&1; then
        echo "ğŸ“‹ Application Logs (last $lines lines)"
        echo "======================================"
        journalctl -u $SERVICE_NAME -n $lines --no-pager
    else
        echo "ğŸ“‹ System Control Logs (last $lines lines)"  
        echo "=========================================="
        tail -n $lines "$LOG_FILE"
    fi
}

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
show_help() {
    echo "Usage: $0 {start|stop|restart|status|logs|help}"
    echo ""
    echo "Commands:"
    echo "  start     Start the application"
    echo "  stop      Stop the application" 
    echo "  restart   Restart the application"
    echo "  status    Show application status"
    echo "  logs      Show recent logs"
    echo "  help      Show this help message"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-help}" in
    "start")
        start_app
        ;;
    "stop")
        stop_app
        ;;
    "restart") 
        restart_app
        ;;
    "status")
        status_app
        ;;
    "logs")
        show_logs "${2:-100}"
        ;;
    "help"|*)
        show_help
        ;;
esac
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/maintenance.sh

set -e

BACKUP_DIR="/backup/readscape"
LOG_FILE="/var/log/readscape/maintenance.log"
RETENTION_DAYS=30

# è¨­å®šèª­ã¿è¾¼ã¿
source /opt/readscape/.env 2>/dev/null || {
    echo "Environment file not found"
    exit 1
}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup_database() {
    log "ğŸ—„ï¸  Starting database backup..."
    
    mkdir -p "$BACKUP_DIR"
    
    BACKUP_FILE="$BACKUP_DIR/readscape_$(date +%Y%m%d_%H%M%S).sql"
    
    PGPASSWORD=$DB_PASSWORD pg_dump \
        -h $DB_HOST \
        -p $DB_PORT \
        -U $DB_USER \
        -d $DB_NAME \
        --verbose \
        --no-password \
        > "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        # åœ§ç¸®
        gzip "$BACKUP_FILE"
        log "âœ… Database backup completed: ${BACKUP_FILE}.gz"
        
        # å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤
        find "$BACKUP_DIR" -name "readscape_*.sql.gz" -mtime +$RETENTION_DAYS -delete
        log "ğŸ§¹ Old backups cleaned up (older than $RETENTION_DAYS days)"
    else
        log "âŒ Database backup failed"
        return 1
    fi
}

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
rotate_logs() {
    log "ğŸ“„ Starting log rotation..."
    
    LOG_DIR="/var/log/readscape"
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
    if [ -f "$LOG_DIR/readscape-api.log" ]; then
        mv "$LOG_DIR/readscape-api.log" "$LOG_DIR/readscape-api.log.$(date +%Y%m%d_%H%M%S)"
        touch "$LOG_DIR/readscape-api.log"
        chown readscape:readscape "$LOG_DIR/readscape-api.log"
        
        # å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®ãƒ»å‰Šé™¤
        find "$LOG_DIR" -name "readscape-api.log.*" -mtime +1 -not -name "*.gz" -exec gzip {} \;
        find "$LOG_DIR" -name "readscape-api.log.*.gz" -mtime +$RETENTION_DAYS -delete
        
        log "âœ… Application logs rotated"
    fi
}

# ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±åé›†
collect_system_info() {
    log "ğŸ“Š Collecting system information..."
    
    INFO_FILE="/tmp/readscape_system_info_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "=== System Information ==="
        echo "Date: $(date)"
        echo "Hostname: $(hostname)"
        echo "Uptime: $(uptime)"
        echo ""
        
        echo "=== Disk Usage ==="
        df -h
        echo ""
        
        echo "=== Memory Usage ==="
        free -h
        echo ""
        
        echo "=== Application Status ==="
        systemctl status readscape-api --no-pager || echo "Service status unavailable"
        echo ""
        
        echo "=== Database Status ==="
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "\l" || echo "Database connection failed"
        echo ""
        
        echo "=== Recent Errors ==="
        journalctl -u readscape-api --since "1 hour ago" --grep "ERROR" --no-pager || echo "No recent errors found"
        
    } > "$INFO_FILE"
    
    log "âœ… System information collected: $INFO_FILE"
}

# ãƒ˜ãƒ«ã‚¹ ãƒã‚§ãƒƒã‚¯
health_check() {
    log "ğŸ¥ Starting comprehensive health check..."
    
    local issues=0
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    if ! curl -f http://localhost:8080/api/actuator/health >/dev/null 2>&1; then
        log "âŒ Application health check failed"
        issues=$((issues + 1))
    else
        log "âœ… Application is healthy"
    fi
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒã‚§ãƒƒã‚¯
    if ! PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "SELECT 1;" >/dev/null 2>&1; then
        log "âŒ Database connection failed"
        issues=$((issues + 1))
    else
        log "âœ… Database connection is healthy"
    fi
    
    # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
    DISK_USAGE=$(df /opt/readscape | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 80 ]; then
        log "âš ï¸  High disk usage: $DISK_USAGE%"
        issues=$((issues + 1))
    else
        log "âœ… Disk usage is normal: $DISK_USAGE%"
    fi
    
    # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
    MEMORY_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2 }')
    if [ $MEMORY_USAGE -gt 90 ]; then
        log "âš ï¸  High memory usage: $MEMORY_USAGE%"
        issues=$((issues + 1))
    else
        log "âœ… Memory usage is normal: $MEMORY_USAGE%"
    fi
    
    if [ $issues -eq 0 ]; then
        log "ğŸ‰ All health checks passed"
        return 0
    else
        log "âš ï¸  Found $issues issues"
        return 1
    fi
}

# ãƒ•ãƒ«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
full_maintenance() {
    log "ğŸ”§ Starting full maintenance..."
    
    backup_database
    rotate_logs
    collect_system_info
    health_check
    
    log "âœ… Full maintenance completed"
}

# ãƒ˜ãƒ«ãƒ—
show_help() {
    echo "Usage: $0 {backup|rotate|info|health|full|help}"
    echo ""
    echo "Commands:"
    echo "  backup    Create database backup"
    echo "  rotate    Rotate log files"
    echo "  info      Collect system information"
    echo "  health    Run health checks"
    echo "  full      Run full maintenance"
    echo "  help      Show this help"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-help}" in
    "backup")
        backup_database
        ;;
    "rotate")
        rotate_logs
        ;;
    "info")
        collect_system_info
        ;;
    "health")
        health_check
        ;;
    "full")
        full_maintenance
        ;;
    "help"|*)
        show_help
        ;;
esac
```

## æŠ€è¡“ä»•æ§˜
- ã‚·ã‚§ãƒ«: Bash 4.0+ with set -e (ã‚¨ãƒ©ãƒ¼æ™‚çµ‚äº†)
- ä¾å­˜é–¢ä¿‚: PostgreSQL client, curl, systemd
- ãƒ­ã‚°: æ§‹é€ åŒ–ãƒ­ã‚° with timestamp
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: é©åˆ‡ãªçµ‚äº†ã‚³ãƒ¼ãƒ‰ã¨ãƒ­ã‚°å‡ºåŠ›
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ç’°å¢ƒå¤‰æ•°ã§ã®æ©Ÿå¯†æƒ…å ±ç®¡ç†