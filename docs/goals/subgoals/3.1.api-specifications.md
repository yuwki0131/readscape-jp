# 3.1 API仕様書

## 概要
OpenAPI 3.0 仕様に基づく包括的なAPI仕様書とエンドユーザー向けドキュメントを提供します。

## OpenAPI仕様

### 基本情報設定
```yaml
openapi: 3.0.3
info:
  title: Readscape-JP API
  description: 日本語対応書籍販売システムのREST API
  version: 1.0.0
  contact:
    name: Readscape-JP API Team
    email: api@readscape.jp
    url: https://readscape.jp/api/docs
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api
    description: 開発環境
  - url: https://api-dev.readscape.jp
    description: テスト環境  
  - url: https://api.readscape.jp
    description: 本番環境
```

### セキュリティスキーマ
```yaml
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT トークンによる認証
    
    AdminAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 管理者用JWT トークン

security:
  - BearerAuth: []
```

### 共通レスポンススキーマ
```yaml
components:
  schemas:
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 処理成功フラグ
        message:
          type: string
          description: レスポンスメッセージ
        timestamp:
          type: string
          format: date-time
          description: レスポンス時刻
      required:
        - success
        - timestamp

    ApiErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: エラーコード
        message:
          type: string
          description: エラーメッセージ
        status:
          type: integer
          description: HTTPステータスコード
        timestamp:
          type: string
          format: date-time
        path:
          type: string
          description: リクエストパス
        fieldErrors:
          type: array
          items:
            $ref: '#/components/schemas/FieldError'
      required:
        - error
        - message
        - status
        - timestamp

    FieldError:
      type: object
      properties:
        field:
          type: string
          description: エラーが発生したフィールド名
        message:
          type: string
          description: フィールドエラーメッセージ
```

### エンドポイント仕様例（書籍API）
```yaml
paths:
  /books:
    get:
      tags:
        - Books
      summary: 書籍一覧取得
      description: 検索条件に基づいて書籍一覧を取得します
      parameters:
        - name: category
          in: query
          description: カテゴリーでフィルタリング
          schema:
            type: string
        - name: keyword
          in: query
          description: 検索キーワード（タイトル・著者名）
          schema:
            type: string
        - name: page
          in: query
          description: ページ番号（0から開始）
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: size
          in: query
          description: ページサイズ
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        '200':
          description: 書籍一覧取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/BookSummary'
                  pagination:
                    $ref: '#/components/schemas/PaginationInfo'
        '400':
          description: リクエストパラメータエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

  /books/{id}:
    get:
      tags:
        - Books
      summary: 書籍詳細取得
      description: 指定されたIDの書籍詳細情報を取得します
      parameters:
        - name: id
          in: path
          required: true
          description: 書籍ID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 書籍詳細取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookDetail'
        '404':
          description: 書籍が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
```

## マニュアル

### エンドユーザー向けAPI利用ガイド

#### 認証方法
```markdown
## 認証について

### JWT トークンの取得
```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

レスポンス:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 3600
}
```

### APIリクエストでの認証
取得したトークンをAuthorizationヘッダーに設定:
```bash
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  http://localhost:8080/api/users/profile
```
```

#### 基本的な使用例
```markdown
## 書籍検索の基本的な使い方

### 1. 全書籍一覧の取得
```bash
curl http://localhost:8080/api/books
```

### 2. カテゴリー別検索
```bash
curl "http://localhost:8080/api/books?category=技術書&page=0&size=20"
```

### 3. キーワード検索
```bash
curl "http://localhost:8080/api/books?keyword=Java&page=0&size=10"
```

### 4. 書籍詳細の取得
```bash
curl http://localhost:8080/api/books/1
```
```

#### ショッピング機能の使用例
```markdown
## カート・注文機能の使い方

### 1. カート内容の確認
```bash
curl -H "Authorization: Bearer <your-token>" \
  http://localhost:8080/api/cart
```

### 2. カートに書籍を追加
```bash
curl -X POST http://localhost:8080/api/cart \
  -H "Authorization: Bearer <your-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "bookId": 1,
    "quantity": 2
  }'
```

### 3. 注文の作成
```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer <your-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "paymentMethod": "credit_card",
    "shippingAddress": "東京都渋谷区..."
  }'
```
```

## レスポンス例

### 成功レスポンス例
```json
{
  "books": [
    {
      "id": 1,
      "title": "Spring Boot実践入門",
      "author": "山田太郎",
      "price": 3200,
      "category": "技術書",
      "rating": 4.5,
      "imageUrl": "https://images.readscape.jp/books/1.jpg"
    },
    {
      "id": 2,
      "title": "Java設計パターン",
      "author": "佐藤花子", 
      "price": 2800,
      "category": "技術書",
      "rating": 4.2,
      "imageUrl": "https://images.readscape.jp/books/2.jpg"
    }
  ],
  "pagination": {
    "currentPage": 0,
    "totalPages": 5,
    "totalElements": 50,
    "size": 10,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

### エラーレスポンス例
```json
{
  "error": "VALIDATION_ERROR",
  "message": "入力値に誤りがあります",
  "status": 400,
  "timestamp": "2024-01-15T10:30:00Z",
  "path": "/api/cart",
  "fieldErrors": [
    {
      "field": "bookId",
      "message": "書籍IDは必須です"
    },
    {
      "field": "quantity",
      "message": "数量は1以上99以下で入力してください"
    }
  ]
}
```

## ドキュメント生成設定

### Springdoc OpenAPI設定
```java
@Configuration
public class OpenApiConfig {
    
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("Readscape-JP API")
                        .version("1.0.0")
                        .description("日本語対応書籍販売システムのREST API")
                        .contact(new Contact()
                                .name("Readscape-JP API Team")
                                .email("api@readscape.jp")))
                .addSecurityItem(new SecurityRequirement()
                        .addList("BearerAuth"))
                .components(new Components()
                        .addSecuritySchemes("BearerAuth",
                                new SecurityScheme()
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")));
    }
}
```

### API アノテーション例
```java
@RestController
@RequestMapping("/api/books")
@Tag(name = "Books", description = "書籍管理API")
public class BooksController {

    @GetMapping
    @Operation(summary = "書籍一覧取得", description = "検索条件に基づいて書籍一覧を取得します")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "200", description = "取得成功"),
        @ApiResponse(responseCode = "400", description = "パラメータエラー")
    })
    public ResponseEntity<BooksResponse> getBooks(
            @Parameter(description = "カテゴリーでフィルタリング") 
            @RequestParam(required = false) String category,
            @Parameter(description = "検索キーワード")
            @RequestParam(required = false) String keyword) {
        // 実装
    }
}
```

## ドキュメント配信

### Swagger UI設定
- URL: `http://localhost:8080/api/swagger-ui.html`
- カスタムCSS適用
- 日本語UI対応
- 認証機能統合

### ReDoc設定
- URL: `http://localhost:8080/api/redoc`
- モバイル対応レスポンシブデザイン
- ダークモード対応

## 技術仕様
- 仕様書: OpenAPI 3.0.3
- 自動生成: springdoc-openapi 2.x
- UIフレームワーク: Swagger UI 5.x + ReDoc
- 認証統合: Spring Security
- バリデーション: Bean Validation アノテーション