# 1.3 共通認証システム

## 概要
一般消費者と在庫管理者の両方に対応したセキュアな認証・認可システムを提供します。

## JWT認証

### トークン仕様
- アルゴリズム: HS256
- 有効期限: アクセストークン（1時間）、リフレッシュトークン（30日）
- ペイロード: ユーザーID、ロール、発行時刻、有効期限

### 実装要件
- トークン生成・検証機能
- リフレッシュトークン機能
- トークン無効化（ブラックリスト）機能
- 秘密鍵のローテーション対応

### エンドポイント
- `POST /api/auth/login` - ログイン（トークン発行）
- `POST /api/auth/refresh` - トークンリフレッシュ
- `POST /api/auth/logout` - ログアウト（トークン無効化）

## ロール管理

### ロール定義
- `CONSUMER`: 一般消費者
  - 書籍閲覧、購入、レビュー投稿
- `ADMIN`: システム管理者
  - 全機能へのアクセス
- `MANAGER`: 在庫管理者
  - 在庫・注文管理機能
- `ANALYST`: 分析担当者
  - 売上分析・レポート機能のみ

### 権限制御
- URL パスベース認可
- メソッドレベル認可（@PreAuthorize）
- リソースレベル認可（データ所有者チェック）

## セッション管理

### セッション仕様
- ステートレス設計（JWT ベース）
- セッション固定攻撃対策
- 同時ログイン制限機能
- 不審なアクセスの検出・通知

### セキュリティ機能
- パスワード強度チェック
- アカウントロックアウト機能
- ログイン試行回数制限
- 二要素認証対応（将来拡張）

## 実装詳細

### Spring Security設定
```java
// セキュリティ設定例
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
    // JWT フィルター設定
    // CORS 設定
    // 認可ルール設定
}
```

### データベース設計
- users テーブル: ユーザー基本情報
- user_roles テーブル: ユーザーロール関連
- refresh_tokens テーブル: リフレッシュトークン管理
- login_attempts テーブル: ログイン試行履歴

## セキュリティ対策

### 攻撃対策
- SQL インジェクション対策（Prepared Statement）
- XSS 攻撃対策（入力サニタイズ）
- CSRF 攻撃対策（トークン検証）
- ブルートフォース攻撃対策（レート制限）

### ログ・監視
- 認証成功/失敗ログ
- 権限エラーログ
- 不審なアクセスパターンの検出
- セキュリティインシデント通知

## 技術仕様
- フレームワーク: Spring Security 6.x
- JWT ライブラリ: jjwt
- パスワードハッシュ: bcrypt
- セッション管理: Redis（将来拡張）
- ログ: SLF4J + Logback