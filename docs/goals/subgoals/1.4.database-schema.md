# 1.4 データベーススキーマ

## 概要
PostgreSQLを使用したReadscape-JPの包括的なデータベース設計と管理システムです。

## PostgreSQLスキーマ

### スキーマ構成
- メインスキーマ: `readscape`
- 全テーブルは readscape スキーマ配下に配置
- 適切なインデックス設計による性能最適化

### テーブル設計

#### 書籍関連テーブル
```sql
-- books テーブル
CREATE TABLE readscape.books (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    author TEXT NOT NULL,
    isbn VARCHAR(13) UNIQUE,
    price INTEGER NOT NULL,
    category_id INTEGER REFERENCES readscape.categories(id),
    description TEXT,
    stock_quantity INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- categories テーブル
CREATE TABLE readscape.categories (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    description TEXT
);
```

#### ユーザー関連テーブル
```sql
-- users テーブル
CREATE TABLE readscape.users (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    email TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'CONSUMER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 注文関連テーブル
```sql
-- orders テーブル
CREATE TABLE readscape.orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES readscape.users(id),
    total_price INTEGER NOT NULL,
    status TEXT NOT NULL DEFAULT 'PENDING',
    payment_method TEXT,
    shipping_address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- order_items テーブル
CREATE TABLE readscape.order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES readscape.orders(id),
    book_id INTEGER NOT NULL REFERENCES readscape.books(id),
    price INTEGER NOT NULL,
    quantity INTEGER NOT NULL
);
```

#### カート関連テーブル
```sql
-- carts テーブル
CREATE TABLE readscape.carts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES readscape.users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- cart_items テーブル
CREATE TABLE readscape.cart_items (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER NOT NULL REFERENCES readscape.carts(id),
    book_id INTEGER NOT NULL REFERENCES readscape.books(id),
    quantity INTEGER NOT NULL,
    UNIQUE(cart_id, book_id)
);
```

#### レビューテーブル
```sql
-- reviews テーブル
CREATE TABLE readscape.reviews (
    id SERIAL PRIMARY KEY,
    book_id INTEGER NOT NULL REFERENCES readscape.books(id),
    user_id INTEGER NOT NULL REFERENCES readscape.users(id),
    rating INTEGER CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(book_id, user_id)
);
```

## マイグレーションスクリプト

### Flyway設定
- バージョン管理: `V{version}__{description}.sql`
- マイグレーション場所: `src/main/resources/db/migration/`
- 本番適用前の検証機能

### マイグレーションファイル例
- `V0001__create_schema_readscape.sql`: スキーマ作成
- `V0002__create_table_books.sql`: 書籍テーブル
- `V0003__create_table_users.sql`: ユーザーテーブル
- `V0004__create_table_carts.sql`: カートテーブル
- `V0005__create_table_cart_items.sql`: カート商品テーブル
- `V0006__create_table_orders.sql`: 注文テーブル
- `V0007__create_table_order_items.sql`: 注文商品テーブル
- `V0008__create_table_reviews.sql`: レビューテーブル

## 初期データ

### サンプルデータ構成
- カテゴリデータ: 文学、技術書、ビジネス書など
- 管理者ユーザー: 初期管理者アカウント
- サンプル書籍: 各カテゴリーの代表的な書籍
- テストユーザー: 開発・テスト用ユーザーアカウント

### データ投入スクリプト
```sql
-- カテゴリ初期データ
INSERT INTO readscape.categories (name, description) VALUES
('文学', '小説・詩・エッセイなど'),
('技術書', 'プログラミング・IT関連書籍'),
('ビジネス書', '経営・マーケティング関連書籍');

-- 管理者ユーザー
INSERT INTO readscape.users (username, email, password_hash, role) VALUES
('admin', 'admin@readscape.jp', '$2a$10$...', 'ADMIN');
```

## パフォーマンス最適化

### インデックス設計
- 主キー: 自動インデックス
- 外部キー: 参照性能向上
- 検索フィールド: title, author, category_id
- 複合インデックス: (user_id, created_at) など

### クエリ最適化
- 適切な JOIN 戦略
- ページネーション最適化
- 集計クエリの効率化
- 接続プール設定

## 技術仕様
- データベース: PostgreSQL 15+
- マイグレーション: Flyway 9.x
- 接続プール: HikariCP
- 文字コード: UTF-8
- タイムゾーン: JST（Asia/Tokyo）