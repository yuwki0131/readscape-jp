# 4.1 自動テスト

## 概要
包括的な自動テスト戦略により、コードの品質保証と安全なリファクタリングを支援します。

## ユニットテスト

### テスト方針
- テストカバレッジ目標: 80%以上
- 各レイヤーごとの独立したテスト
- テストファースト開発（TDD）の推奨
- モックを活用した外部依存の分離

### テスト構成例
```java
// Service層のユニットテスト例
@ExtendWith(MockitoExtension.class)
class BookServiceTest {

    @Mock
    private BookRepository bookRepository;
    
    @Mock
    private ReviewRepository reviewRepository;
    
    @InjectMocks
    private BookService bookService;
    
    @Test
    @DisplayName("書籍IDで書籍詳細を正常取得")
    void findBookById_Success() {
        // Given
        Long bookId = 1L;
        Book expectedBook = Book.builder()
                .id(bookId)
                .title("Spring Boot実践入門")
                .author("山田太郎")
                .price(3200)
                .build();
        
        when(bookRepository.findById(bookId)).thenReturn(Optional.of(expectedBook));
        when(reviewRepository.calculateAverageRatingByBookId(bookId)).thenReturn(4.5);
        
        // When
        BookDetail result = bookService.findBookById(bookId);
        
        // Then
        assertThat(result.getId()).isEqualTo(bookId);
        assertThat(result.getTitle()).isEqualTo("Spring Boot実践入門");
        assertThat(result.getAverageRating()).isEqualTo(4.5);
        
        verify(bookRepository).findById(bookId);
        verify(reviewRepository).calculateAverageRatingByBookId(bookId);
    }
    
    @Test
    @DisplayName("存在しない書籍ID指定時に例外発生")
    void findBookById_NotFound() {
        // Given
        Long nonExistentId = 999L;
        when(bookRepository.findById(nonExistentId)).thenReturn(Optional.empty());
        
        // When & Then
        assertThatThrownBy(() -> bookService.findBookById(nonExistentId))
                .isInstanceOf(BookNotFoundException.class)
                .hasMessage("Book not found with id: " + nonExistentId);
    }
}
```

### Repository層テスト
```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Testcontainers
class BookRepositoryTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15")
            .withDatabaseName("readscape_test")
            .withUsername("test_user")
            .withPassword("test_pass");

    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private BookRepository bookRepository;
    
    @Test
    @DisplayName("カテゴリー別書籍検索")
    void findByCategoryName_Success() {
        // Given
        Category techCategory = entityManager.persist(
                Category.builder().name("技術書").build());
        
        Book book1 = entityManager.persist(Book.builder()
                .title("Spring Boot入門")
                .author("技術太郎")
                .category(techCategory)
                .build());
                
        entityManager.flush();
        
        // When
        List<Book> result = bookRepository.findByCategoryName("技術書");
        
        // Then
        assertThat(result).hasSize(1);
        assertThat(result.get(0).getTitle()).isEqualTo("Spring Boot入門");
    }
}
```

### Controller層テスト
```java
@WebMvcTest(BooksController.class)
class BooksControllerTest {

    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private BookService bookService;
    
    @Test
    @DisplayName("書籍一覧取得API正常動作")
    void getBooks_Success() throws Exception {
        // Given
        List<BookSummary> books = Arrays.asList(
                BookSummary.builder()
                        .id(1L)
                        .title("Spring Boot実践")
                        .author("山田太郎")
                        .price(3200)
                        .build()
        );
        
        when(bookService.findBooks(any(), any(), any())).thenReturn(books);
        
        // When & Then
        mockMvc.perform(get("/api/books")
                        .param("category", "技術書")
                        .param("page", "0")
                        .param("size", "10"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(1)))
                .andExpect(jsonPath("$[0].title").value("Spring Boot実践"))
                .andExpect(jsonPath("$[0].author").value("山田太郎"))
                .andExpect(jsonPath("$[0].price").value(3200));
    }
    
    @Test
    @DisplayName("バリデーションエラー時の400レスポンス")
    void addToCart_ValidationError() throws Exception {
        // Given
        String invalidRequest = """
                {
                    "bookId": null,
                    "quantity": 0
                }
                """;
        
        // When & Then
        mockMvc.perform(post("/api/cart")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(invalidRequest))
                .andExpect(status().isBadRequest())
                .andExpect(jsonPath("$.error").value("VALIDATION_ERROR"))
                .andExpect(jsonPath("$.fieldErrors").isArray())
                .andExpect(jsonPath("$.fieldErrors[0].field").value("bookId"))
                .andExpected(jsonPath("$.fieldErrors[0].message").exists());
    }
}
```

## 統合テスト

### API統合テスト
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
@Transactional
class BookApiIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15");
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private BookRepository bookRepository;
    
    @Test
    @DisplayName("書籍の完全CRUD操作統合テスト")
    void bookCrudIntegrationTest() {
        // Create - 書籍作成
        CreateBookRequest createRequest = CreateBookRequest.builder()
                .title("統合テスト入門")
                .author("テスト太郎")
                .price(2800)
                .categoryId(1L)
                .build();
        
        ResponseEntity<CreateBookResponse> createResponse = restTemplate
                .withBasicAuth("admin", "admin123")
                .postForEntity("/api/admin/books", createRequest, CreateBookResponse.class);
        
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        Long bookId = createResponse.getBody().getId();
        
        // Read - 書籍取得
        ResponseEntity<BookDetail> getResponse = restTemplate
                .getForEntity("/api/books/" + bookId, BookDetail.class);
        
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(getResponse.getBody().getTitle()).isEqualTo("統合テスト入門");
        
        // Update - 書籍更新
        UpdateBookRequest updateRequest = UpdateBookRequest.builder()
                .title("統合テスト実践")
                .author("テスト太郎")
                .price(3200)
                .build();
        
        restTemplate
                .withBasicAuth("admin", "admin123")
                .put("/api/admin/books/" + bookId, updateRequest);
        
        // Delete - 書籍削除
        restTemplate
                .withBasicAuth("admin", "admin123")
                .delete("/api/admin/books/" + bookId);
        
        // 削除確認
        ResponseEntity<String> deletedResponse = restTemplate
                .getForEntity("/api/books/" + bookId, String.class);
        assertThat(deletedResponse.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
    }
}
```

### セキュリティ統合テスト
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class SecurityIntegrationTest {

    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    @DisplayName("未認証ユーザーの管理者API拒否")
    void adminApiWithoutAuth_Forbidden() {
        ResponseEntity<String> response = restTemplate
                .getForEntity("/api/admin/books", String.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    }
    
    @Test
    @DisplayName("一般ユーザーの管理者API拒否")
    void adminApiWithUserAuth_Forbidden() {
        String userToken = getUserToken();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(userToken);
        HttpEntity<String> entity = new HttpEntity<>(headers);
        
        ResponseEntity<String> response = restTemplate
                .exchange("/api/admin/books", HttpMethod.GET, entity, String.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
    }
    
    private String getUserToken() {
        LoginRequest loginRequest = new LoginRequest("user@test.com", "password");
        ResponseEntity<LoginResponse> response = restTemplate
                .postForEntity("/api/auth/login", loginRequest, LoginResponse.class);
        return response.getBody().getToken();
    }
}
```

## リポジトリテスト

### データベーストランザクションテスト
```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Testcontainers
class TransactionTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15");
    
    @Autowired
    private CartItemRepository cartItemRepository;
    
    @Autowired
    private BookRepository bookRepository;
    
    @Test
    @DisplayName("カートアイテム追加時の在庫減算トランザクション")
    @Transactional
    void addToCart_StockDecrement() {
        // Given
        Book book = bookRepository.save(Book.builder()
                .title("テスト書籍")
                .stockQuantity(10)
                .build());
        
        // When
        CartItem cartItem = CartItem.builder()
                .book(book)
                .quantity(3)
                .build();
        cartItemRepository.save(cartItem);
        
        // Then
        Book updatedBook = bookRepository.findById(book.getId()).orElseThrow();
        assertThat(updatedBook.getStockQuantity()).isEqualTo(7);
    }
    
    @Test
    @DisplayName("在庫不足時の例外とロールバック確認")
    void addToCart_InsufficientStock_Rollback() {
        // Given
        Book book = bookRepository.save(Book.builder()
                .title("在庫不足書籍")
                .stockQuantity(2)
                .build());
        
        // When & Then
        assertThatThrownBy(() -> {
            CartItem cartItem = CartItem.builder()
                    .book(book)
                    .quantity(5) // 在庫を超える数量
                    .build();
            cartItemRepository.save(cartItem);
        }).isInstanceOf(InsufficientStockException.class);
        
        // ロールバック確認
        Book unchangedBook = bookRepository.findById(book.getId()).orElseThrow();
        assertThat(unchangedBook.getStockQuantity()).isEqualTo(2);
    }
}
```

### カスタムクエリテスト
```java
@DataJpaTest
class CustomQueryTest {

    @Autowired
    private BookRepository bookRepository;
    
    @Test
    @DisplayName("複雑な検索条件での書籍取得")
    void findBooksWithComplexConditions() {
        // Given
        Category techCategory = entityManager.persist(
                Category.builder().name("技術書").build());
        
        Book book1 = entityManager.persist(Book.builder()
                .title("Spring入門")
                .author("Java太郎")
                .price(2800)
                .category(techCategory)
                .stockQuantity(10)
                .build());
        
        // When
        List<Book> results = bookRepository
                .findByTitleContainingAndPriceBetweenAndStockQuantityGreaterThan(
                        "Spring", 2000, 3000, 5);
        
        // Then
        assertThat(results).hasSize(1);
        assertThat(results.get(0).getTitle()).contains("Spring");
    }
}
```

## テスト設定

### TestContainers設定
```java
@TestConfiguration
public class TestContainersConfig {

    @Bean
    @Primary
    @DynamicPropertySource
    public static PostgreSQLContainer<?> postgreSQLContainer() {
        PostgreSQLContainer<?> container = new PostgreSQLContainer<>("postgres:15")
                .withDatabaseName("readscape_test")
                .withUsername("test_user")
                .withPassword("test_pass")
                .withInitScript("test-data.sql");
        
        container.start();
        
        System.setProperty("spring.datasource.url", container.getJdbcUrl());
        System.setProperty("spring.datasource.username", container.getUsername());
        System.setProperty("spring.datasource.password", container.getPassword());
        
        return container;
    }
}
```

### テスト用プロファイル設定
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:tc:postgresql:15:///readscape_test
    driver-class-name: org.testcontainers.jdbc.ContainerDatabaseDriver
  
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  
  flyway:
    enabled: false

logging:
  level:
    jp.readscape: DEBUG
    org.hibernate.SQL: DEBUG
    org.springframework.test: DEBUG
```

### テストデータ管理
```java
@Component
@Profile("test")
public class TestDataBuilder {

    @Autowired
    private BookRepository bookRepository;
    
    @Autowired
    private CategoryRepository categoryRepository;
    
    public Book createTestBook(String title, String author, Integer price) {
        Category defaultCategory = categoryRepository.findByName("テスト")
                .orElseGet(() -> categoryRepository.save(
                        Category.builder().name("テスト").build()));
        
        return bookRepository.save(Book.builder()
                .title(title)
                .author(author)
                .price(price)
                .category(defaultCategory)
                .stockQuantity(10)
                .build());
    }
    
    public User createTestUser(String email, String password) {
        return userRepository.save(User.builder()
                .email(email)
                .username("testuser")
                .passwordHash(passwordEncoder.encode(password))
                .role(UserRole.CONSUMER)
                .build());
    }
}
```

## テスト実行設定

### Gradle テスト設定
```gradle
test {
    useJUnitPlatform()
    
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
    
    systemProperty 'spring.profiles.active', 'test'
    
    //並列実行設定
    maxParallelForks = Runtime.runtime.availableProcessors()
    
    // メモリ設定
    minHeapSize = "512m"
    maxHeapSize = "2048m"
}

// テストカバレッジ
jacoco {
    toolVersion = "0.8.8"
}

jacocoTestReport {
    reports {
        xml.required = true
        html.required = true
    }
    
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                '**/configuration/**',
                '**/dto/**',
                '**/*Application*'
            ])
        }))
    }
}
```

## 技術仕様
- テストフレームワーク: JUnit 5 + AssertJ
- モックフレームワーク: Mockito
- 統合テスト: Spring Boot Test + TestContainers
- カバレッジ: JaCoCo
- データベース: PostgreSQL TestContainer